# Power Automate Desktop Flow - SharePoint 資料夾分享腳本
# 記得先安裝 Power Automate Desktop 喔！

# 變數設定區
SET RootFolderPath TO 'C:\你的資料夾路徑'  # 改成你的實際路徑
SET SharePointSiteUrl TO 'https://你的組織.sharepoint.com/sites/你的網站'
SET EmailSubject TO '您的專屬資料夾已經準備好囉！'
SET EmailBody TO '哈囉 {UserName}，

您的專屬資料夾已經設定完成，您現在有編輯權限了。

資料夾位置：{FolderUrl}

如有任何問題請隨時聯繫我們。

祝工作愉快！'

# 主流程開始
BLOCK '主要流程'
    # 1. 取得所有子資料夾
    Folder.GetSubfolders Folder: RootFolderPath Subfolders=> SubFolders
    
    # 2. 迴圈處理每個子資料夾
    LOOP FOREACH CurrentFolder IN SubFolders
        # 取得資料夾名稱（即使用者名稱）
        SET UserName TO CurrentFolder.Name
        
        # 建立錯誤處理
        ON ERROR
            # 記錄錯誤
            Text.AppendLine Text: 'Error processing folder for user: ' & UserName & ' - Error: ' & LastError File: 'C:\SharePointSharingLog.txt'
            CONTINUE
        END
        
        # 3. 呼叫 SharePoint API 設定權限
        BLOCK '設定 SharePoint 權限'
            # 使用 HTTP Request 來呼叫 SharePoint REST API
            SET FolderRelativeUrl TO '/sites/你的網站/Shared Documents/' & UserName
            
            # 取得使用者資訊
            SET GetUserEndpoint TO SharePointSiteUrl & '/_api/web/siteusers?$filter=LoginName eq ''i:0#.f|membership|' & UserName & '@你的組織.com'''
            
            Web.InvokeWebService.InvokeWebService Url: GetUserEndpoint \
                Method: 'GET' \
                Accept: 'application/json' \
                ContentType: 'application/json' \
                CustomHeaders: {'Authorization': 'Bearer ' & AccessToken} \
                Response=> UserResponse
            
            # 解析使用者 ID
            Variables.ConvertJsonToCustomObject Json: UserResponse.BodyAsText CustomObject=> UserObject
            SET UserId TO UserObject.value[0].Id
            
            # 設定資料夾權限
            SET PermissionEndpoint TO SharePointSiteUrl & '/_api/web/GetFolderByServerRelativeUrl(''' & FolderRelativeUrl & ''')/ListItemAllFields/roleassignments/addroleassignment(principalid=' & UserId & ',roledefid=1073741827)'
            
            Web.InvokeWebService.InvokeWebService Url: PermissionEndpoint \
                Method: 'POST' \
                Accept: 'application/json' \
                ContentType: 'application/json' \
                CustomHeaders: {'Authorization': 'Bearer ' & AccessToken, 'X-RequestDigest': FormDigestValue} \
                Response=> PermissionResponse
        END
        
        # 4. 發送電子郵件
        BLOCK '發送通知郵件'
            # 準備郵件內容
            SET FolderUrl TO SharePointSiteUrl & '/Shared Documents/' & UserName
            SET PersonalizedEmailBody TO EmailBody
            Text.Replace Text: PersonalizedEmailBody TextToFind: '{UserName}' TextToReplace: UserName ReplacedText=> PersonalizedEmailBody
            Text.Replace Text: PersonalizedEmailBody TextToFind: '{FolderUrl}' TextToReplace: FolderUrl ReplacedText=> PersonalizedEmailBody
            
            # 使用 Outlook 發送郵件
            Outlook.Launch Instance=> OutlookInstance
            Outlook.SendEmail Instance: OutlookInstance \
                Account: '你的郵件帳號@組織.com' \
                To: UserName & '@你的組織.com' \
                Subject: EmailSubject \
                Body: PersonalizedEmailBody \
                IsBodyHtml: False
        END
        
        # 記錄成功
        Text.AppendLine Text: 'Successfully processed folder for user: ' & UserName File: 'C:\SharePointSharingLog.txt'
        
        # 避免太快，加個延遲
        WAIT 2
    END
    
    # 關閉 Outlook
    Outlook.Close Instance: OutlookInstance
    
    # 顯示完成訊息
    Display.ShowMessage Title: '處理完成' \
        Message: '所有資料夾已成功分享並發送郵件通知！' \
        Icon: Display.Icon.Information \
        Buttons: Display.Buttons.OK
END