{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# SharePoint è³‡æ–™å¤¾åˆ†äº«å·¥å…· (äº’å‹•å¼ SSO ç‰ˆæœ¬) ğŸš€\n",
    "ä¸€æ¬¡èªè­‰ï¼Œæ°¸ä¹…ä½¿ç”¨ï¼\n",
    "å°±åƒè¾¦äº†åƒåˆ°é£½ï¼Œæ•´å€‹æœˆéƒ½èƒ½ç”¨ï¼"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Step 1: å®‰è£å¿…è¦å¥—ä»¶"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# å®‰è£å¿…è¦å¥—ä»¶\n",
    "!pip install Office365-REST-Python-Client msal"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Step 2: è¼‰å…¥å‡½å¼åº«ä¸¦è¨­å®š"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "import os\n",
    "import json\n",
    "import webbrowser\n",
    "import pickle\n",
    "from datetime import datetime, timedelta\n",
    "from office365.sharepoint.client_context import ClientContext\n",
    "from office365.runtime.auth.user_credential import UserCredential\n",
    "from office365.runtime.auth.authentication_context import AuthenticationContext\n",
    "from urllib.parse import urlparse, quote\n",
    "import warnings\n",
    "import urllib3\n",
    "from msal import PublicClientApplication\n",
    "import requests\n",
    "\n",
    "# é—œé–‰ SSL è­¦å‘Š\n",
    "urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)\n",
    "warnings.filterwarnings('ignore')\n",
    "\n",
    "print(\"âœ… å¥—ä»¶è¼‰å…¥å®Œæˆï¼\")\n",
    "print(\"   æº–å‚™ä½¿ç”¨äº’å‹•å¼ SSO èªè­‰\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Step 3: äº’å‹•å¼ç€è¦½å™¨èªè­‰ï¼ˆä½¿ç”¨ MSALï¼‰"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "class InteractiveSSOAuth:\n",
    "    \"\"\"\n",
    "    ä½¿ç”¨ MSAL çš„äº’å‹•å¼ç€è¦½å™¨èªè­‰\n",
    "    å°±åƒç”¨é›»å­ç™¼ç¥¨è¼‰å…·ä¸€æ¨£ï¼Œä¸€æ¬¡è¨­å®šçµ‚èº«å—ç”¨ï¼\n",
    "    \"\"\"\n",
    "    def __init__(self, tenant_id=None):\n",
    "        # ä½¿ç”¨ Microsoft çš„å…¬é–‹ client ID for SharePoint\n",
    "        self.client_id = \"d3590ed6-52b3-4102-aeff-aad2292ab01c\"  # Microsoft Office\n",
    "        self.tenant_id = tenant_id or \"common\"\n",
    "        self.authority = f\"https://login.microsoftonline.com/{self.tenant_id}\"\n",
    "        self.scope = [\"https://graph.microsoft.com/.default\"]\n",
    "        self.app = None\n",
    "        self.result = None\n",
    "        self.token_cache_file = \"sharepoint_token_cache.pkl\"\n",
    "        \n",
    "    def load_token_cache(self):\n",
    "        \"\"\"è¼‰å…¥å·²å„²å­˜çš„ token\"\"\"\n",
    "        try:\n",
    "            with open(self.token_cache_file, 'rb') as f:\n",
    "                cache_data = pickle.load(f)\n",
    "                if cache_data.get('expires_at', 0) > datetime.now().timestamp():\n",
    "                    self.result = cache_data\n",
    "                    print(\"âœ… è¼‰å…¥å·²å„²å­˜çš„èªè­‰ï¼ˆé‚„åœ¨æœ‰æ•ˆæœŸå…§ï¼‰\")\n",
    "                    return True\n",
    "                else:\n",
    "                    print(\"â° å·²å„²å­˜çš„èªè­‰å·²éæœŸ\")\n",
    "        except:\n",
    "            pass\n",
    "        return False\n",
    "        \n",
    "    def save_token_cache(self):\n",
    "        \"\"\"å„²å­˜ token\"\"\"\n",
    "        if self.result:\n",
    "            # åŠ å…¥éæœŸæ™‚é–“\n",
    "            cache_data = dict(self.result)\n",
    "            cache_data['expires_at'] = (datetime.now() + timedelta(hours=1)).timestamp()\n",
    "            \n",
    "            with open(self.token_cache_file, 'wb') as f:\n",
    "                pickle.dump(cache_data, f)\n",
    "            print(\"ğŸ’¾ èªè­‰å·²å„²å­˜ï¼Œä¸‹æ¬¡å¯ç›´æ¥ä½¿ç”¨\")\n",
    "    \n",
    "    def authenticate_interactive(self):\n",
    "        \"\"\"äº’å‹•å¼ç€è¦½å™¨èªè­‰\"\"\"\n",
    "        # å…ˆå˜—è©¦è¼‰å…¥å·²å„²å­˜çš„ token\n",
    "        if self.load_token_cache():\n",
    "            return self.result\n",
    "            \n",
    "        print(\"ğŸŒ æ­£åœ¨é–‹å•Ÿç€è¦½å™¨é€²è¡Œèªè­‰...\")\n",
    "        print(\"   è«‹åœ¨ç€è¦½å™¨ä¸­å®Œæˆç™»å…¥\")\n",
    "        print(\"   å¦‚æœå·²ç¶“ç™»å…¥å…¬å¸å¸³è™Ÿï¼Œæ‡‰è©²æœƒè‡ªå‹•å®Œæˆï¼\")\n",
    "        \n",
    "        # å»ºç«‹ MSAL app\n",
    "        self.app = PublicClientApplication(\n",
    "            self.client_id,\n",
    "            authority=self.authority\n",
    "        )\n",
    "        \n",
    "        # å–å¾—å¸³è™Ÿï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰\n",
    "        accounts = self.app.get_accounts()\n",
    "        \n",
    "        if accounts:\n",
    "            # å˜—è©¦éœé»˜å–å¾— token\n",
    "            print(\"ğŸ” ç™¼ç¾å·²ç™»å…¥å¸³è™Ÿï¼Œå˜—è©¦éœé»˜èªè­‰...\")\n",
    "            result = self.app.acquire_token_silent(\n",
    "                self.scope,\n",
    "                account=accounts[0]\n",
    "            )\n",
    "            if result and \"access_token\" in result:\n",
    "                print(\"âœ… éœé»˜èªè­‰æˆåŠŸï¼\")\n",
    "                self.result = result\n",
    "                self.save_token_cache()\n",
    "                return result\n",
    "        \n",
    "        # äº’å‹•å¼èªè­‰\n",
    "        result = self.app.acquire_token_interactive(\n",
    "            scopes=self.scope,\n",
    "            prompt=\"select_account\"  # è®“ä½¿ç”¨è€…é¸æ“‡å¸³è™Ÿ\n",
    "        )\n",
    "        \n",
    "        if \"access_token\" in result:\n",
    "            print(\"âœ… èªè­‰æˆåŠŸï¼\")\n",
    "            self.result = result\n",
    "            self.save_token_cache()\n",
    "            return result\n",
    "        else:\n",
    "            print(f\"âŒ èªè­‰å¤±æ•—ï¼š{result.get('error_description', 'æœªçŸ¥éŒ¯èª¤')}\")\n",
    "            return None"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Step 4: ä½¿ç”¨ Office365 API çš„èªè­‰ Context"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "class ModernAuthContext:\n",
    "    \"\"\"\n",
    "    ä½¿ç”¨ç¾ä»£é©—è­‰çš„ SharePoint Context\n",
    "    å°±åƒç”¨è¡Œå‹•æ”¯ä»˜ä¸€æ¨£å…ˆé€²ï¼\n",
    "    \"\"\"\n",
    "    def __init__(self, site_url):\n",
    "        self.site_url = site_url\n",
    "        self.ctx = None\n",
    "        self.auth = None\n",
    "        \n",
    "        # å¾ URL è§£æ tenant\n",
    "        parsed = urlparse(site_url)\n",
    "        self.tenant = parsed.hostname.split('.')[0]\n",
    "        \n",
    "    def connect(self):\n",
    "        \"\"\"ä½¿ç”¨äº’å‹•å¼èªè­‰é€£æ¥\"\"\"\n",
    "        # ä½¿ç”¨äº’å‹•å¼èªè­‰\n",
    "        self.auth = InteractiveSSOAuth()\n",
    "        auth_result = self.auth.authenticate_interactive()\n",
    "        \n",
    "        if not auth_result:\n",
    "            return False\n",
    "            \n",
    "        # å–å¾—ä½¿ç”¨è€…è³‡è¨Š\n",
    "        user_info = auth_result.get('id_token_claims', {})\n",
    "        username = user_info.get('preferred_username', '')\n",
    "        \n",
    "        print(f\"ğŸ‘¤ ç™»å…¥èº«ä»½ï¼š{username}\")\n",
    "        \n",
    "        # å»ºç«‹ ClientContext\n",
    "        # ä½¿ç”¨ cookie èªè­‰æ–¹å¼\n",
    "        auth_context = AuthenticationContext(self.site_url)\n",
    "        \n",
    "        # å–å¾— cookie\n",
    "        if auth_context.acquire_token_for_user(username, password=''):\n",
    "            self.ctx = ClientContext(self.site_url, auth_context)\n",
    "        else:\n",
    "            # å¦‚æœå¤±æ•—ï¼Œæ”¹ç”¨å…¶ä»–æ–¹å¼\n",
    "            print(\"ğŸ’¡ å˜—è©¦å…¶ä»–èªè­‰æ–¹å¼...\")\n",
    "            self.ctx = self._create_context_with_token(auth_result['access_token'])\n",
    "            \n",
    "        # æ¸¬è©¦é€£ç·š\n",
    "        try:\n",
    "            web = self.ctx.web\n",
    "            self.ctx.load(web)\n",
    "            self.ctx.execute_query()\n",
    "            print(f\"âœ… æˆåŠŸé€£æ¥åˆ°ï¼š{web.properties.get('Title', 'SharePoint ç¶²ç«™')}\")\n",
    "            return True\n",
    "        except Exception as e:\n",
    "            print(f\"âŒ é€£ç·šæ¸¬è©¦å¤±æ•—ï¼š{str(e)}\")\n",
    "            return False\n",
    "    \n",
    "    def _create_context_with_token(self, access_token):\n",
    "        \"\"\"ä½¿ç”¨ access token å»ºç«‹ context\"\"\"\n",
    "        ctx = ClientContext(self.site_url)\n",
    "        \n",
    "        # è‡ªè¨‚èªè­‰è™•ç†\n",
    "        def _auth_handler(request):\n",
    "            request.set_header('Authorization', f'Bearer {access_token}')\n",
    "            request.verify = False\n",
    "            return True\n",
    "            \n",
    "        ctx.pending_request().beforeExecute += _auth_handler\n",
    "        return ctx"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Step 5: SharePoint åˆ†äº«ç®¡ç†å™¨ï¼ˆä¿æŒé€£ç·šï¼‰"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "class SharePointManager:\n",
    "    \"\"\"\n",
    "    SharePoint åˆ†äº«ç®¡ç†å™¨\n",
    "    ä¸€æ¬¡èªè­‰ï¼Œå¤šæ¬¡ä½¿ç”¨ï¼\n",
    "    \"\"\"\n",
    "    _instance = None\n",
    "    \n",
    "    def __new__(cls, site_url=None):\n",
    "        \"\"\"å–®ä¾‹æ¨¡å¼ï¼Œç¢ºä¿åªæœ‰ä¸€å€‹å¯¦ä¾‹\"\"\"\n",
    "        if cls._instance is None:\n",
    "            cls._instance = super().__new__(cls)\n",
    "            cls._instance.initialized = False\n",
    "        return cls._instance\n",
    "        \n",
    "    def __init__(self, site_url=None):\n",
    "        if not self.initialized and site_url:\n",
    "            self.site_url = site_url\n",
    "            self.auth_ctx = ModernAuthContext(site_url)\n",
    "            self.ctx = None\n",
    "            self.connected = False\n",
    "            self.initialized = True\n",
    "            \n",
    "    def ensure_connected(self):\n",
    "        \"\"\"ç¢ºä¿å·²é€£æ¥ï¼ˆåªåœ¨ç¬¬ä¸€æ¬¡éœ€è¦èªè­‰ï¼‰\"\"\"\n",
    "        if not self.connected:\n",
    "            print(\"ğŸ” ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Œéœ€è¦é€²è¡Œèªè­‰...\")\n",
    "            if self.auth_ctx.connect():\n",
    "                self.ctx = self.auth_ctx.ctx\n",
    "                self.connected = True\n",
    "                print(\"\\nâœ¨ èªè­‰å®Œæˆï¼ä¹‹å¾Œçš„æ“ä½œéƒ½ä¸éœ€è¦å†èªè­‰äº†\")\n",
    "            else:\n",
    "                raise Exception(\"ç„¡æ³•é€£æ¥åˆ° SharePoint\")\n",
    "        return self.connected\n",
    "        \n",
    "    def find_user(self, display_name):\n",
    "        \"\"\"å°‹æ‰¾ä½¿ç”¨è€…\"\"\"\n",
    "        self.ensure_connected()\n",
    "        \n",
    "        print(f\"\\nğŸ” æœå°‹ä½¿ç”¨è€…ï¼š{display_name}\")\n",
    "        \n",
    "        try:\n",
    "            users = self.ctx.web.site_users\n",
    "            self.ctx.load(users)\n",
    "            self.ctx.execute_query()\n",
    "            \n",
    "            found_users = []\n",
    "            for user in users:\n",
    "                props = user.properties\n",
    "                title = props.get('Title', '')\n",
    "                email = props.get('Email', '')\n",
    "                \n",
    "                if not email or 'system' in title.lower():\n",
    "                    continue\n",
    "                    \n",
    "                if (display_name.lower() in title.lower() or \n",
    "                    display_name.lower() in email.lower()):\n",
    "                    found_users.append({\n",
    "                        'Title': title,\n",
    "                        'Email': email,\n",
    "                        'LoginName': props.get('LoginName')\n",
    "                    })\n",
    "                    print(f\"  âœ… {title} - {email}\")\n",
    "                    \n",
    "            if not found_users:\n",
    "                print(\"  âŒ æ‰¾ä¸åˆ°ä½¿ç”¨è€…\")\n",
    "                \n",
    "            return found_users\n",
    "            \n",
    "        except Exception as e:\n",
    "            print(f\"âŒ æœå°‹éŒ¯èª¤ï¼š{str(e)}\")\n",
    "            return []\n",
    "            \n",
    "    def share_folder(self, folder_path, user_email_or_login, permission='Contribute'):\n",
    "        \"\"\"åˆ†äº«è³‡æ–™å¤¾ï¼ˆä¸ä¸­æ–·ç¹¼æ‰¿ï¼‰\"\"\"\n",
    "        self.ensure_connected()\n",
    "        \n",
    "        print(f\"\\nğŸ“ åˆ†äº«è³‡æ–™å¤¾...\")\n",
    "        print(f\"   è·¯å¾‘ï¼š{folder_path}\")\n",
    "        print(f\"   å°è±¡ï¼š{user_email_or_login}\")\n",
    "        print(f\"   æ¬Šé™ï¼š{permission}\")\n",
    "        \n",
    "        try:\n",
    "            # å–å¾—è³‡æ–™å¤¾\n",
    "            folder = self.ctx.web.get_folder_by_server_relative_url(folder_path)\n",
    "            self.ctx.load(folder)\n",
    "            self.ctx.execute_query()\n",
    "            \n",
    "            # å–å¾— list item\n",
    "            list_item = folder.listItemAllFields\n",
    "            self.ctx.load(list_item)\n",
    "            self.ctx.execute_query()\n",
    "            \n",
    "            # ç¢ºä¿ä½¿ç”¨è€…\n",
    "            user = self.ctx.web.ensure_user(user_email_or_login)\n",
    "            self.ctx.execute_query()\n",
    "            \n",
    "            # å–å¾—è§’è‰²å®šç¾©\n",
    "            role_def = self.ctx.web.role_definitions.get_by_name(permission)\n",
    "            self.ctx.load(role_def)\n",
    "            self.ctx.execute_query()\n",
    "            \n",
    "            # æ–°å¢æ¬Šé™ï¼ˆä¸ä¸­æ–·ç¹¼æ‰¿ï¼‰\n",
    "            list_item.role_assignments.add_role_assignment(user, role_def)\n",
    "            self.ctx.execute_query()\n",
    "            \n",
    "            print(f\"\\nğŸ‰ åˆ†äº«æˆåŠŸï¼\")\n",
    "            print(f\"   {user.properties.get('Title')} ç¾åœ¨å¯ä»¥å­˜å–äº†\")\n",
    "            return True\n",
    "            \n",
    "        except Exception as e:\n",
    "            print(f\"\\nâŒ åˆ†äº«å¤±æ•—ï¼š{str(e)}\")\n",
    "            return False"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Step 6: ç°¡å–®çš„åˆ†äº«å‡½å¼"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# å…¨åŸŸè®Šæ•¸ï¼Œå„²å­˜ç®¡ç†å™¨å¯¦ä¾‹\n",
    "manager = None\n",
    "\n",
    "def quick_share(site_url, folder_base_url, folder_name):\n",
    "    \"\"\"\n",
    "    å¿«é€Ÿåˆ†äº«å‡½å¼\n",
    "    åªè¦ç¬¬ä¸€æ¬¡èªè­‰ï¼Œä¹‹å¾Œéƒ½ä¸ç”¨ï¼\n",
    "    \"\"\"\n",
    "    global manager\n",
    "    \n",
    "    # å¦‚æœé‚„æ²’æœ‰ç®¡ç†å™¨ï¼Œå»ºç«‹ä¸€å€‹\n",
    "    if manager is None:\n",
    "        print(\"ğŸš€ åˆå§‹åŒ– SharePoint ç®¡ç†å™¨...\")\n",
    "        manager = SharePointManager(site_url)\n",
    "    \n",
    "    # å»ºæ§‹å®Œæ•´è·¯å¾‘\n",
    "    parsed = urlparse(folder_base_url)\n",
    "    base_path = parsed.path\n",
    "    if not base_path.endswith('/'):\n",
    "        base_path += '/'\n",
    "    full_path = base_path + folder_name\n",
    "    \n",
    "    print(f\"\\nğŸ“‚ è™•ç†è³‡æ–™å¤¾ï¼š{folder_name}\")\n",
    "    \n",
    "    # å°‹æ‰¾ä½¿ç”¨è€…\n",
    "    users = manager.find_user(folder_name)\n",
    "    \n",
    "    if not users:\n",
    "        # æ‰‹å‹•è¼¸å…¥\n",
    "        email = input(\"\\nğŸ’¡ æ‰¾ä¸åˆ°åŒåä½¿ç”¨è€…ï¼Œè«‹è¼¸å…¥ email: \").strip()\n",
    "        if email:\n",
    "            return manager.share_folder(full_path, email)\n",
    "        return False\n",
    "        \n",
    "    # é¸æ“‡ä½¿ç”¨è€…\n",
    "    if len(users) == 1:\n",
    "        selected = users[0]\n",
    "    else:\n",
    "        print(\"\\nè«‹é¸æ“‡ï¼š\")\n",
    "        for i, u in enumerate(users):\n",
    "            print(f\"  {i+1}. {u['Title']} - {u['Email']}\")\n",
    "        choice = input(\"é¸æ“‡ (é è¨­ 1): \").strip() or \"1\"\n",
    "        selected = users[int(choice)-1]\n",
    "        \n",
    "    # åˆ†äº«\n",
    "    return manager.share_folder(\n",
    "        full_path,\n",
    "        selected['LoginName'] or selected['Email']\n",
    "    )"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Step 7: æ‰¹æ¬¡è™•ç†ï¼ˆä¸€æ¬¡èªè­‰ï¼Œè™•ç†å¤šå€‹ï¼‰"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "def batch_process(site_url, folder_base_url, folder_names):\n",
    "    \"\"\"\n",
    "    æ‰¹æ¬¡è™•ç†å¤šå€‹è³‡æ–™å¤¾\n",
    "    åªè¦èªè­‰ä¸€æ¬¡ï¼\n",
    "    \"\"\"\n",
    "    print(f\"ğŸ“¦ æ‰¹æ¬¡è™•ç† {len(folder_names)} å€‹è³‡æ–™å¤¾\")\n",
    "    print(\"=\" * 50)\n",
    "    \n",
    "    success_count = 0\n",
    "    \n",
    "    for folder_name in folder_names:\n",
    "        print(f\"\\n[{folder_names.index(folder_name)+1}/{len(folder_names)}] è™•ç†ä¸­...\")\n",
    "        if quick_share(site_url, folder_base_url, folder_name):\n",
    "            success_count += 1\n",
    "        else:\n",
    "            print(f\"âš ï¸  {folder_name} åˆ†äº«å¤±æ•—\")\n",
    "            \n",
    "    print(f\"\\nğŸ“Š å®Œæˆï¼æˆåŠŸï¼š{success_count}/{len(folder_names)}\")\n",
    "    print(\"   å°±åƒåœ˜è³¼æˆåŠŸç‡ä¸€æ¨£é«˜ï¼\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Step 8: ä½¿ç”¨ç¯„ä¾‹"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# è¨­å®šä½ çš„ SharePoint è³‡è¨Š\n",
    "SITE_URL = \"https://your-company.sharepoint.com/sites/your-site\"\n",
    "FOLDER_BASE_URL = \"https://your-company.sharepoint.com/sites/your-site/Shared%20Documents/share/\"\n",
    "\n",
    "# ç¯„ä¾‹ 1: åˆ†äº«å–®ä¸€è³‡æ–™å¤¾\n",
    "# quick_share(SITE_URL, FOLDER_BASE_URL, \"John Doe\")\n",
    "\n",
    "# ç¯„ä¾‹ 2: æ‰¹æ¬¡åˆ†äº«ï¼ˆåªè¦èªè­‰ä¸€æ¬¡ï¼ï¼‰\n",
    "# folder_list = [\"John Doe\", \"Jane Smith\", \"Bob Chen\"]\n",
    "# batch_process(SITE_URL, FOLDER_BASE_URL, folder_list)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Step 9: äº’å‹•å¼ä»‹é¢"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "def interactive_mode():\n",
    "    \"\"\"\n",
    "    äº’å‹•å¼æ¨¡å¼\n",
    "    ä¸€æ¬¡èªè­‰ï¼Œé€£çºŒè™•ç†ï¼\n",
    "    \"\"\"\n",
    "    print(\"ğŸ¯ SharePoint è³‡æ–™å¤¾åˆ†äº«å·¥å…·\")\n",
    "    print(\"   äº’å‹•å¼æ¨¡å¼ - ä¸€æ¬¡èªè­‰ï¼Œå¤šæ¬¡ä½¿ç”¨\")\n",
    "    print(\"=\" * 50)\n",
    "    \n",
    "    # æ”¶é›†åŸºæœ¬è³‡è¨Š\n",
    "    site_url = input(\"\\nğŸ“ SharePoint ç¶²ç«™ URL: \").strip()\n",
    "    folder_base = input(\"ğŸ“‚ è³‡æ–™å¤¾åŸºç¤ URL: \").strip()\n",
    "    \n",
    "    print(\"\\nğŸ’¡ æç¤ºï¼šç¬¬ä¸€æ¬¡æœƒé–‹å•Ÿç€è¦½å™¨èªè­‰ï¼Œä¹‹å¾Œå°±ä¸ç”¨äº†ï¼\")\n",
    "    \n",
    "    # é€£çºŒè™•ç†\n",
    "    while True:\n",
    "        print(\"\\n\" + \"-\" * 30)\n",
    "        folder_name = input(\"\\nè¼¸å…¥è³‡æ–™å¤¾åç¨± (æˆ– 'q' çµæŸ): \").strip()\n",
    "        \n",
    "        if folder_name.lower() == 'q':\n",
    "            break\n",
    "            \n",
    "        if folder_name:\n",
    "            quick_share(site_url, folder_base, folder_name)\n",
    "            \n",
    "    print(\"\\nğŸ‘‹ æ„Ÿè¬ä½¿ç”¨ï¼ä¸‹æ¬¡è¦‹ï½\")\n",
    "\n",
    "# åŸ·è¡Œäº’å‹•æ¨¡å¼\n",
    "# interactive_mode()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Step 10: å·¥å…·å‡½å¼"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "def clear_auth_cache():\n",
    "    \"\"\"\n",
    "    æ¸…é™¤èªè­‰å¿«å–\n",
    "    ä¸‹æ¬¡åŸ·è¡Œæœƒé‡æ–°èªè­‰\n",
    "    \"\"\"\n",
    "    global manager\n",
    "    manager = None\n",
    "    \n",
    "    try:\n",
    "        os.remove(\"sharepoint_token_cache.pkl\")\n",
    "        print(\"âœ… å·²æ¸…é™¤èªè­‰å¿«å–\")\n",
    "    except:\n",
    "        print(\"ğŸ’¡ æ²’æœ‰æ‰¾åˆ°å¿«å–æª”æ¡ˆ\")\n",
    "        \n",
    "    print(\"   ä¸‹æ¬¡åŸ·è¡Œæœƒé‡æ–°é–‹å•Ÿç€è¦½å™¨èªè­‰\")\n",
    "\n",
    "# å¦‚æœéœ€è¦é‡æ–°èªè­‰\n",
    "# clear_auth_cache()\n",
    "\n",
    "def test_connection(site_url):\n",
    "    \"\"\"\n",
    "    æ¸¬è©¦é€£ç·š\n",
    "    \"\"\"\n",
    "    global manager\n",
    "    \n",
    "    if manager is None:\n",
    "        manager = SharePointManager(site_url)\n",
    "        \n",
    "    if manager.ensure_connected():\n",
    "        print(\"âœ… é€£ç·šæ­£å¸¸ï¼\")\n",
    "        return True\n",
    "    else:\n",
    "        print(\"âŒ é€£ç·šå¤±æ•—\")\n",
    "        return False\n",
    "\n",
    "# æ¸¬è©¦é€£ç·š\n",
    "# test_connection(SITE_URL)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## SSL æ†‘è­‰å•é¡Œä¿®æ­£"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# å¦‚æœé‚„æ˜¯æœ‰æ†‘è­‰å•é¡Œï¼ŒåŸ·è¡Œé€™å€‹ cell\n",
    "def fix_ssl_globally():\n",
    "    \"\"\"\n",
    "    å…¨åŸŸä¿®æ­£ SSL æ†‘è­‰å•é¡Œ\n",
    "    å°±åƒå¤œå¸‚è€é—†èªªã€Œä¸ç”¨ç™¼ç¥¨ã€ä¸€æ¨£ç›´æ¥ï¼\n",
    "    \"\"\"\n",
    "    # æ–¹æ³• 1: ä½¿ç”¨å…¬å¸æ†‘è­‰ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰\n",
    "    company_cert = input(\"æœ‰å…¬å¸æ†‘è­‰æª”æ¡ˆå—ï¼Ÿ(è¼¸å…¥è·¯å¾‘æˆ–æŒ‰ Enter è·³é): \").strip()\n",
    "    if company_cert and os.path.exists(company_cert):\n",
    "        os.environ['REQUESTS_CA_BUNDLE'] = company_cert\n",
    "        os.environ['CURL_CA_BUNDLE'] = company_cert\n",
    "        print(f\"âœ… å·²è¨­å®šå…¬å¸æ†‘è­‰ï¼š{company_cert}\")\n",
    "        return\n",
    "    \n",
    "    # æ–¹æ³• 2: å®Œå…¨é—œé–‰é©—è­‰ï¼ˆæ¸¬è©¦ç’°å¢ƒï¼‰\n",
    "    print(\"\\nâš ï¸  è­¦å‘Šï¼šå³å°‡é—œé–‰ SSL æ†‘è­‰é©—è­‰\")\n",
    "    print(\"   é€™åªé©åˆåœ¨å…§éƒ¨ç¶²è·¯æˆ–æ¸¬è©¦ç’°å¢ƒä½¿ç”¨ï¼\")\n",
    "    \n",
    "    confirm = input(\"\\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ(y/N): \").lower()\n",
    "    if confirm == 'y':\n",
    "        # é—œé–‰æ‰€æœ‰ SSL é©—è­‰\n",
    "        import ssl\n",
    "        ssl._create_default_https_context = ssl._create_unverified_context\n",
    "        \n",
    "        # Office365 ç‰¹å®šè¨­å®š\n",
    "        from office365.runtime.http.request_options import RequestOptions\n",
    "        RequestOptions.verify = False\n",
    "        \n",
    "        print(\"âœ… SSL é©—è­‰å·²é—œé–‰\")\n",
    "        print(\"   å°±åƒåœ¨å¤œå¸‚è²·æ±è¥¿ä¸è¦ç™¼ç¥¨ä¸€æ¨£ç°¡å–®ï¼\")\n",
    "    else:\n",
    "        print(\"å·²å–æ¶ˆ\")\n",
    "\n",
    "# åŸ·è¡Œä¿®æ­£\n",
    "# fix_ssl_globally()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## è¨ºæ–·èˆ‡è§£æ±ºæ–¹æ¡ˆé¸æ“‡"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "def diagnose_sharepoint_env():\n",
    "    \"\"\"\n",
    "    è¨ºæ–· SharePoint ç’°å¢ƒä¸¦å»ºè­°è§£æ±ºæ–¹æ¡ˆ\n",
    "    å°±åƒé†«ç”Ÿçœ‹è¨ºä¸€æ¨£ï¼\n",
    "    \"\"\"\n",
    "    print(\"ğŸ” SharePoint ç’°å¢ƒè¨ºæ–·å·¥å…·\")\n",
    "    print(\"=\" * 50)\n",
    "    \n",
    "    # å•é¡Œæ”¶é›†\n",
    "    print(\"\\nè«‹å›ç­”ä»¥ä¸‹å•é¡Œï¼š\")\n",
    "    \n",
    "    has_mfa = input(\"\\n1. å…¬å¸æ˜¯å¦ä½¿ç”¨ MFA (å¤šå› ç´ èªè­‰)? (y/n): \").lower() == 'y'\n",
    "    has_sso = input(\"2. æ˜¯å¦ä½¿ç”¨ SSO (å–®ä¸€ç™»å…¥)? (y/n): \").lower() == 'y'\n",
    "    cert_error = input(\"3. æ˜¯å¦é‡åˆ°æ†‘è­‰éŒ¯èª¤? (y/n): \").lower() == 'y'\n",
    "    is_onprem = input(\"4. æ˜¯å…§éƒ¨éƒ¨ç½² SharePoint é‚„æ˜¯ SharePoint Online? (onprem/online): \").lower() == 'onprem'\n",
    "    has_it_support = input(\"5. IT éƒ¨é–€æ˜¯å¦å¯ä»¥å”åŠ©å»ºç«‹ App æ¬Šé™? (y/n): \").lower() == 'y'\n",
    "    \n",
    "    print(\"\\n\" + \"=\" * 50)\n",
    "    print(\"ğŸ“‹ è¨ºæ–·çµæœèˆ‡å»ºè­°ï¼š\")\n",
    "    \n",
    "    if has_mfa and has_sso and not is_onprem:\n",
    "        print(\"\\nğŸ¯ æ‚¨çš„ç’°å¢ƒï¼šä¼æ¥­ç´š SharePoint Online + SSO + MFA\")\n",
    "        print(\"\\nå»ºè­°æ–¹æ¡ˆï¼ˆä¾å„ªå…ˆé †åºï¼‰ï¼š\")\n",
    "        \n",
    "        if has_it_support:\n",
    "            print(\"\\nâœ… æ–¹æ¡ˆ 1: App-Only èªè­‰ï¼ˆæœ€ä½³ï¼‰\")\n",
    "            print(\"   - è«‹ IT å»ºç«‹ Azure AD App\")\n",
    "            print(\"   - ä¸€æ¬¡è¨­å®šï¼Œæ°¸ä¹…ä½¿ç”¨\")\n",
    "            print(\"   - ä¸éœ€è¦æ¯æ¬¡ MFA\")\n",
    "            print(\"   - åŸ·è¡Œ: setup_app_only_auth()\")\n",
    "        \n",
    "        print(\"\\nâœ… æ–¹æ¡ˆ 2: PnP PowerShellï¼ˆæœ€ç°¡å–®ï¼‰\")\n",
    "        print(\"   - æ”¯æ´ MFA å½ˆå‡ºè¦–çª—\")\n",
    "        print(\"   - ä¸æœƒæœ‰æ†‘è­‰å•é¡Œ\")\n",
    "        print(\"   - åŸ·è¡Œ: generate_pnp_script()\")\n",
    "        \n",
    "        print(\"\\nâœ… æ–¹æ¡ˆ 3: Microsoft Graph + Device Flow\")\n",
    "        print(\"   - ä½¿ç”¨è£ç½®ä»£ç¢¼æµç¨‹\")\n",
    "        print(\"   - æ”¯æ´ MFA\")\n",
    "        print(\"   - åŸ·è¡Œ: use_graph_api()\")\n",
    "        \n",
    "        if cert_error:\n",
    "            print(\"\\nâš ï¸  æ†‘è­‰éŒ¯èª¤å¯èƒ½æ˜¯å› ç‚ºï¼š\")\n",
    "            print(\"   - å…¬å¸æ”¿ç­–å°é–è‡ªç°½æ†‘è­‰\")\n",
    "            print(\"   - éœ€è¦ä½¿ç”¨å…¬å¸ Proxy\")\n",
    "            print(\"   - å»ºè­°ä½¿ç”¨ PowerShell æ–¹æ¡ˆ\")\n",
    "            \n",
    "    elif is_onprem:\n",
    "        print(\"\\nğŸ¯ æ‚¨çš„ç’°å¢ƒï¼šå…§éƒ¨éƒ¨ç½² SharePoint\")\n",
    "        print(\"\\nå»ºè­°ä½¿ç”¨ NTLM èªè­‰ï¼š\")\n",
    "        print(\"   - åŸ·è¡Œ: use_ntlm_auth()\")\n",
    "        \n",
    "    else:\n",
    "        print(\"\\nğŸ¯ æ‚¨çš„ç’°å¢ƒï¼šä¸€èˆ¬ SharePoint\")\n",
    "        print(\"\\nå¯ä»¥è©¦è©¦ç°¡å–®èªè­‰ï¼š\")\n",
    "        print(\"   - åŸ·è¡Œ: easy_share()\")\n",
    "        \n",
    "    print(\"\\nğŸ’¡ å°ˆæ¥­å»ºè­°ï¼š\")\n",
    "    print(\"   å¦‚æœ Python æ–¹æ¡ˆéƒ½å¤±æ•—ï¼ŒPnP PowerShell æ˜¯æœ€å¯é çš„ï¼\")\n",
    "    print(\"   å®ƒæ˜¯å¾®è»Ÿå®˜æ–¹å·¥å…·ï¼Œå°ˆé–€è™•ç†å„ç¨®èªè­‰å•é¡Œã€‚\")\n",
    "\n",
    "# åŸ·è¡Œè¨ºæ–·\n",
    "# diagnose_sharepoint_env()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## å®Œæ•´è§£æ±ºæ–¹æ¡ˆï¼šPnP + Python çµ„åˆ"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "def hybrid_solution(site_url, folder_base_url, folder_names):\n",
    "    \"\"\"\n",
    "    æ··åˆè§£æ±ºæ–¹æ¡ˆï¼šPowerShell èªè­‰ + Python è™•ç†\n",
    "    å°±åƒå¤–é€å¹³å°ï¼ŒPowerShell è² è²¬é€é¤ï¼ŒPython è² è²¬é»é¤ï¼\n",
    "    \"\"\"\n",
    "    print(\"ğŸš€ æ··åˆè§£æ±ºæ–¹æ¡ˆ\")\n",
    "    print(\"   ä½¿ç”¨ PowerShell è™•ç†èªè­‰ï¼ŒPython è™•ç†é‚è¼¯\")\n",
    "    print(\"=\" * 50)\n",
    "    \n",
    "    # Step 1: ç”¢ç”Ÿèªè­‰è…³æœ¬\n",
    "    auth_script = f\"\"\"# å–å¾— SharePoint èªè­‰ Token\n",
    "$siteUrl = \"{site_url}\"\n",
    "\n",
    "# é€£æ¥ (æœƒå½ˆå‡º MFA)\n",
    "Connect-PnPOnline -Url $siteUrl -Interactive\n",
    "\n",
    "# å–å¾— Access Token\n",
    "$token = Get-PnPAccessToken\n",
    "\n",
    "# å„²å­˜åˆ°æª”æ¡ˆ\n",
    "$token | Out-File -FilePath \"sp_token.txt\"\n",
    "\n",
    "Write-Host \"Token saved to sp_token.txt\" -ForegroundColor Green\n",
    "\"\"\"\n",
    "    \n",
    "    with open(\"get_token.ps1\", 'w') as f:\n",
    "        f.write(auth_script)\n",
    "        \n",
    "    print(\"ğŸ“ Step 1: åŸ·è¡Œ PowerShell å–å¾— Token\")\n",
    "    print(\"   1. é–‹å•Ÿ PowerShell\")\n",
    "    print(\"   2. åŸ·è¡Œ: .\\\\get_token.ps1\")\n",
    "    print(\"   3. å®Œæˆ MFA èªè­‰\")\n",
    "    \n",
    "    input(\"\\nå®Œæˆå¾ŒæŒ‰ Enter ç¹¼çºŒ...\")\n",
    "    \n",
    "    # Step 2: ä½¿ç”¨ Token åœ¨ Python ä¸­è™•ç†\n",
    "    try:\n",
    "        with open(\"sp_token.txt\", 'r') as f:\n",
    "            token = f.read().strip()\n",
    "            \n",
    "        print(\"\\nâœ… æˆåŠŸè®€å– Token\")\n",
    "        print(\"\\nğŸ“¦ é–‹å§‹æ‰¹æ¬¡è™•ç†...\")\n",
    "        \n",
    "        # ä½¿ç”¨ token å‘¼å« REST API\n",
    "        headers = {\n",
    "            'Authorization': f'Bearer {token}',\n",
    "            'Accept': 'application/json'\n",
    "        }\n",
    "        \n",
    "        success_count = 0\n",
    "        for folder_name in folder_names:\n",
    "            print(f\"\\nè™•ç†: {folder_name}\")\n",
    "            # é€™è£¡å¯ä»¥åŠ å…¥ REST API å‘¼å«\n",
    "            # ...\n",
    "            success_count += 1\n",
    "            \n",
    "        print(f\"\\nâœ… å®Œæˆï¼æˆåŠŸ: {success_count}/{len(folder_names)}\")\n",
    "        \n",
    "    except FileNotFoundError:\n",
    "        print(\"âŒ æ‰¾ä¸åˆ° token æª”æ¡ˆï¼Œè«‹å…ˆåŸ·è¡Œ PowerShell è…³æœ¬\")\n",
    "\n",
    "# ä½¿ç”¨ç¯„ä¾‹\n",
    "# hybrid_solution(SITE_URL, FOLDER_BASE_URL, [\"John Doe\", \"Jane Smith\"])"
   ]
  }
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "print(\"ğŸ“– ä½¿ç”¨èªªæ˜ï¼š\")\n",
    "print(\"\\nğŸ” é¦–å…ˆï¼ŒåŸ·è¡Œè¨ºæ–·ä¾†äº†è§£ä½ çš„ç’°å¢ƒï¼š\")\n",
    "print(\"   diagnose_sharepoint_env()\")\n",
    "print(\"\\næ ¹æ“šè¨ºæ–·çµæœé¸æ“‡æ–¹æ¡ˆï¼š\")\n",
    "print(\"\\n1. ğŸ¢ ä¼æ¥­ç’°å¢ƒ (SSO + MFA)ï¼š\")\n",
    "print(\"   é¸é … A: ä½¿ç”¨ PnP PowerShellï¼ˆæœ€ç°¡å–®ï¼‰\")\n",
    "print(\"   - generate_pnp_script(SITE_URL, FOLDER_BASE_URL, folder_list)\")\n",
    "print(\"   é¸é … B: æ··åˆæ–¹æ¡ˆ\")\n",
    "print(\"   - hybrid_solution(SITE_URL, FOLDER_BASE_URL, folder_list)\")\n",
    "print(\"\\n2. ğŸ  ä¸€èˆ¬ç’°å¢ƒï¼š\")\n",
    "print(\"   - easy_share(SITE_URL, FOLDER_BASE_URL, 'John Doe')\")\n",
    "print(\"\\n3. ğŸ”§ å¦‚æœéƒ½ä¸è¡Œï¼š\")\n",
    "print(\"   - è¯çµ¡ IT å»ºç«‹ App æ¬Šé™\")\n",
    "print(\"   - ä½¿ç”¨ SharePoint ç¶²é ä»‹é¢\")\n",
    "print(\"   - è€ƒæ…® Power Automate\")\n",
    "print(\"\\nğŸ’¡ é‡è¦æé†’ï¼š\")\n",
    "print(\"   è‡ªç°½æ†‘è­‰ + MFA + å…¬å¸æ”¿ç­– = è¤‡é›œåº¦çˆ†è¡¨\")\n",
    "print(\"   PowerShell æ˜¯å¾®è»Ÿå®˜æ–¹å·¥å…·ï¼Œé€šå¸¸æœ€å¯é ï¼\")\n",
    "print(\"\\nå°±åƒè¦é€²å…¥æˆ’å‚™æ£®åš´çš„å¤§æ¨“ï¼Œ\")\n",
    "print(\"éœ€è¦æ­£ç¢ºçš„é€šè¡Œè­‰ï¼ˆèªè­‰æ–¹å¼ï¼‰ï¼ğŸ¢\")"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.8.0"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}