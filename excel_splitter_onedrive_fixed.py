#!/usr/bin/env python3
"""
ä¿®æ­£ç‰ˆ OneDrive Excel åˆ†å‰²å™¨
è§£æ±ºã€Œæª”æ¡ˆæ ¼å¼æˆ–å‰¯æª”åç„¡æ•ˆã€éŒ¯èª¤

ä¸»è¦æ”¹é€²ï¼š
1. ä½¿ç”¨éš±è—åˆ—æ›¿ä»£åˆªé™¤åˆ—
2. ä¿æŒæª”æ¡ˆçµæ§‹å®Œæ•´æ€§
3. åŠ å¼·éŒ¯èª¤è™•ç†å’Œé©—è­‰
4. æä¾›å¤šç¨®è™•ç†æ–¹æ³•é¸æ“‡
"""

import os
import shutil
import pandas as pd
from pathlib import Path
from openpyxl import load_workbook
from openpyxl.utils import get_column_letter
import glob
from datetime import datetime
from typing import Dict, List, Optional, Tuple
import platform
import sys

def create_jupyter_notebook_fixed():
    """å»ºç«‹ä¿®æ­£ç‰ˆçš„ Jupyter notebook å…§å®¹"""
    
    notebook_content = """
{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Excel åˆ†å‰²å™¨ - OneDrive ä¿®æ­£ç‰ˆ\\n",
    "\\n",
    "## ğŸš¨ è§£æ±ºæª”æ¡ˆæ ¼å¼éŒ¯èª¤å•é¡Œ\\n",
    "\\n",
    "æ­¤ç‰ˆæœ¬å°ˆé–€è§£æ±º OneDrive ç‰ˆæœ¬å‡ºç¾çš„ã€Œæª”æ¡ˆæ ¼å¼æˆ–å‰¯æª”åç„¡æ•ˆã€éŒ¯èª¤ã€‚\\n",
    "\\n",
    "### ä¸»è¦ä¿®æ­£ï¼š\\n",
    "- âœ… **ä½¿ç”¨éš±è—åˆ—æ›¿ä»£åˆªé™¤åˆ—**ï¼šé¿å…ç ´å£æª”æ¡ˆçµæ§‹\\n",
    "- âœ… **ä¿ç•™å®Œæ•´è³‡æ–™é©—è­‰**ï¼šç¶­æŒæ‰€æœ‰ Excel åŠŸèƒ½\\n",
    "- âœ… **åŠ å¼·æª”æ¡ˆé©—è­‰**ï¼šç¢ºä¿è¼¸å‡ºæª”æ¡ˆå¯æ­£å¸¸é–‹å•Ÿ\\n",
    "- âœ… **å¤šé‡è™•ç†æ–¹æ³•**ï¼šæä¾›ä¸åŒç¨‹åº¦çš„è™•ç†é¸é …\\n",
    "- âœ… **è©³ç´°éŒ¯èª¤è¿½è¹¤**ï¼šå”åŠ©è¨ºæ–·å•é¡Œ\\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "source": [
    "# å®‰è£èˆ‡åŒ¯å…¥å¿…è¦å¥—ä»¶\\n",
    "import sys\\n",
    "import subprocess\\n",
    "import platform\\n",
    "\\n",
    "required_packages = [\\n",
    "    'pandas',\\n",
    "    'openpyxl',\\n",
    "    'ipywidgets'\\n",
    "]\\n",
    "\\n",
    "print(\\"ğŸ” æª¢æŸ¥å¥—ä»¶å®‰è£ç‹€æ…‹...\\")\\n",
    "for package in required_packages:\\n",
    "    try:\\n",
    "        __import__(package.replace('-', '_'))\\n",
    "        print(f\\"âœ“ {package} å·²å®‰è£\\")\\n",
    "    except ImportError:\\n",
    "        print(f\\"ğŸ“¦ æ­£åœ¨å®‰è£ {package}...\\")\\n",
    "        subprocess.check_call([sys.executable, \\"-m\\", \\"pip\\", \\"install\\", package])\\n",
    "        print(f\\"âœ“ {package} å®‰è£å®Œæˆ\\")\\n",
    "\\n",
    "print(\\"\\\\nâœ… æ‰€æœ‰å¿…è¦å¥—ä»¶å·²å°±ç·’ï¼\\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "source": [
    "import os\\n",
    "import shutil\\n",
    "import pandas as pd\\n",
    "from pathlib import Path\\n",
    "from openpyxl import load_workbook\\n",
    "from openpyxl.utils import get_column_letter\\n",
    "import glob\\n",
    "from datetime import datetime\\n",
    "from IPython.display import display, HTML, clear_output\\n",
    "import ipywidgets as widgets\\n",
    "import time\\n",
    "from typing import Dict, List, Optional, Tuple\\n",
    "import re\\n",
    "\\n",
    "# æª¢æŸ¥ tkinter (æª”æ¡ˆå°è©±æ¡†)\\n",
    "try:\\n",
    "    import tkinter as tk\\n",
    "    from tkinter import filedialog, messagebox\\n",
    "    TKINTER_AVAILABLE = True\\n",
    "except ImportError:\\n",
    "    TKINTER_AVAILABLE = False\\n",
    "\\n",
    "print(\\"âœ“ å‡½å¼åº«åŒ¯å…¥æˆåŠŸ\\")\\n",
    "print(f\\"âœ“ ä½œæ¥­ç³»çµ±: {platform.system()}\\")\\n",
    "print(f\\"âœ“ æª”æ¡ˆå°è©±æ¡†: {'å¯ç”¨' if TKINTER_AVAILABLE else 'ä¸å¯ç”¨'}\\")\\n",
    "\\n",
    "# å…¨åŸŸè®Šæ•¸\\n",
    "last_folder = os.path.expanduser(\\"~\\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## ğŸ”§ æ ¸å¿ƒä¿®æ­£å‡½æ•¸\\n",
    "\\n",
    "ä»¥ä¸‹æ˜¯è§£æ±ºæª”æ¡ˆæ ¼å¼å•é¡Œçš„æ ¸å¿ƒå‡½æ•¸ï¼š"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "source": [
    "def sanitize_folder_name(name: str) -> str:\\n",
    "    \\"\\"\\"æ¸…ç†è³‡æ–™å¤¾åç¨±ï¼Œç¢ºä¿ç›¸å®¹æ€§\\"\\"\\"\\n",
    "    invalid_chars = ['/', '\\\\\\\\', ':', '*', '?', '\"', '<', '>', '|', '#', '%']\\n",
    "    sanitized = name.strip()\\n",
    "    \\n",
    "    for char in invalid_chars:\\n",
    "        sanitized = sanitized.replace(char, '_')\\n",
    "    \\n",
    "    if len(sanitized) > 255:\\n",
    "        sanitized = sanitized[:255].rstrip()\\n",
    "    \\n",
    "    return sanitized\\n",
    "\\n",
    "def find_column(worksheet, column_name):\\n",
    "    \\"\\"\\"åœ¨å·¥ä½œè¡¨ä¸­å°‹æ‰¾æ¬„ä½\\"\\"\\"\\n",
    "    for col_idx, cell in enumerate(worksheet[1], start=1):\\n",
    "        if cell.value == column_name:\\n",
    "            return col_idx\\n",
    "    raise ValueError(f\\"æ‰¾ä¸åˆ° '{column_name}' æ¬„ä½ï¼\\")\\n",
    "\\n",
    "def validate_excel_file(file_path):\\n",
    "    \\"\\"\\"é©—è­‰ Excel æª”æ¡ˆçš„å®Œæ•´æ€§\\"\\"\\"\\n",
    "    try:\\n",
    "        wb = load_workbook(file_path, data_only=False)\\n",
    "        ws = wb.active\\n",
    "        \\n",
    "        # åŸºæœ¬æª¢æŸ¥\\n",
    "        checks = {\\n",
    "            'has_data': ws.max_row > 1,\\n",
    "            'has_columns': ws.max_column > 0,\\n",
    "            'first_row_exists': ws.cell(1, 1).value is not None,\\n",
    "            'can_save': True\\n",
    "        }\\n",
    "        \\n",
    "        # å˜—è©¦å„²å­˜æ¸¬è©¦\\n",
    "        temp_path = file_path + '.temp.xlsx'\\n",
    "        wb.save(temp_path)\\n",
    "        os.remove(temp_path)\\n",
    "        \\n",
    "        wb.close()\\n",
    "        return checks, None\\n",
    "    except Exception as e:\\n",
    "        return None, str(e)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "source": [
    "def process_reviewer_excel_hide_rows_safe(file_path, reviewer, column_name, output_folder):\\n",
    "    \\"\\"\\"\\n",
    "    ğŸš¨ ä¿®æ­£ç‰ˆè™•ç†å‡½æ•¸ - ä½¿ç”¨éš±è—åˆ—æ–¹æ³•\\n",
    "    è§£æ±ºæª”æ¡ˆæ ¼å¼éŒ¯èª¤çš„æ ¸å¿ƒæ–¹æ³•\\n",
    "    \\"\\"\\"\\n",
    "    try:\\n",
    "        reviewer_name = sanitize_folder_name(str(reviewer).strip())\\n",
    "        reviewer_folder = os.path.join(output_folder, reviewer_name)\\n",
    "        os.makedirs(reviewer_folder, exist_ok=True)\\n",
    "        \\n",
    "        base_name = os.path.basename(file_path)\\n",
    "        name_without_ext = os.path.splitext(base_name)[0]\\n",
    "        ext = os.path.splitext(base_name)[1]\\n",
    "        new_filename = f\\"{name_without_ext} - {reviewer_name}{ext}\\"\\n",
    "        dst_path = os.path.join(reviewer_folder, new_filename)\\n",
    "        \\n",
    "        # å…ˆè¤‡è£½æ•´å€‹æª”æ¡ˆ\\n",
    "        shutil.copy2(file_path, dst_path)\\n",
    "        print(f\\"  âœ“ å·²è¤‡è£½æª”æ¡ˆ: {new_filename}\\")\\n",
    "        \\n",
    "        # è¼‰å…¥ä¸¦è™•ç†æª”æ¡ˆ\\n",
    "        wb = load_workbook(dst_path, data_only=False, keep_vba=True, keep_links=True)\\n",
    "        main_ws = wb.active\\n",
    "        \\n",
    "        # å°‹æ‰¾å¯©æŸ¥è€…æ¬„ä½\\n",
    "        col_idx = find_column(main_ws, column_name)\\n",
    "        \\n",
    "        # ğŸ”§ é—œéµä¿®æ­£ï¼šä½¿ç”¨éš±è—åˆ—è€Œéåˆªé™¤åˆ—\\n",
    "        rows_to_hide = []\\n",
    "        for row in range(2, main_ws.max_row + 1):\\n",
    "            cell_value = main_ws.cell(row=row, column=col_idx).value\\n",
    "            if str(cell_value).strip() != str(reviewer).strip():\\n",
    "                rows_to_hide.append(row)\\n",
    "        \\n",
    "        print(f\\"  âœ“ æ‰¾åˆ° {len(rows_to_hide)} åˆ—éœ€è¦éš±è—\\")\\n",
    "        \\n",
    "        # éš±è—éç›¸é—œåˆ—ï¼ˆä¿æŒæª”æ¡ˆçµæ§‹å®Œæ•´ï¼‰\\n",
    "        for row in rows_to_hide:\\n",
    "            main_ws.row_dimensions[row].hidden = True\\n",
    "        \\n",
    "        # è¨­å®šè‡ªå‹•ç¯©é¸\\n",
    "        if main_ws.max_row > 1:\\n",
    "            try:\\n",
    "                # æ¸…é™¤ç¾æœ‰ç¯©é¸\\n",
    "                main_ws.auto_filter.ref = None\\n",
    "                \\n",
    "                # è¨­å®šæ–°çš„ç¯©é¸ç¯„åœ\\n",
    "                filter_range = f\\"A1:{get_column_letter(main_ws.max_column)}{main_ws.max_row}\\"\\n",
    "                main_ws.auto_filter.ref = filter_range\\n",
    "                \\n",
    "                # è¨­å®šç¯©é¸æ¢ä»¶\\n",
    "                main_ws.auto_filter.add_filter_column(col_idx - 1, [str(reviewer)])\\n",
    "                print(f\\"  âœ“ å·²è¨­å®šç¯©é¸æ¢ä»¶\\")\\n",
    "            except Exception as e:\\n",
    "                print(f\\"  âš ï¸ ç¯©é¸è¨­å®šè­¦å‘Š: {e}\\")\\n",
    "        \\n",
    "        # å„²å­˜è®Šæ›´\\n",
    "        wb.save(dst_path)\\n",
    "        wb.close()\\n",
    "        \\n",
    "        # é©—è­‰è¼¸å‡ºæª”æ¡ˆ\\n",
    "        validation, error = validate_excel_file(dst_path)\\n",
    "        if error:\\n",
    "            print(f\\"  âŒ è¼¸å‡ºæª”æ¡ˆé©—è­‰å¤±æ•—: {error}\\")\\n",
    "            return False, None, None\\n",
    "        else:\\n",
    "            print(f\\"  âœ… è¼¸å‡ºæª”æ¡ˆé©—è­‰é€šéï¼Œæª”æ¡ˆå¯æ­£å¸¸é–‹å•Ÿ\\")\\n",
    "        \\n",
    "        return True, reviewer_folder, new_filename\\n",
    "        \\n",
    "    except Exception as e:\\n",
    "        print(f\\"âŒ è™•ç† {reviewer} æ™‚ç™¼ç”ŸéŒ¯èª¤: {str(e)}\\")\\n",
    "        import traceback\\n",
    "        traceback.print_exc()\\n",
    "        return False, None, None"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "source": [
    "def process_reviewer_excel_minimal_safe(file_path, reviewer, column_name, output_folder):\\n",
    "    \\"\\"\\"\\n",
    "    ğŸ›¡ï¸ æœ€å®‰å…¨è™•ç†æ–¹æ³• - åƒ…è¤‡è£½å’Œç¯©é¸\\n",
    "    é©ç”¨æ–¼é«˜åº¦æ•æ„Ÿæˆ–è¤‡é›œçš„ Excel æª”æ¡ˆ\\n",
    "    \\"\\"\\"\\n",
    "    try:\\n",
    "        reviewer_name = sanitize_folder_name(str(reviewer).strip())\\n",
    "        reviewer_folder = os.path.join(output_folder, reviewer_name)\\n",
    "        os.makedirs(reviewer_folder, exist_ok=True)\\n",
    "        \\n",
    "        base_name = os.path.basename(file_path)\\n",
    "        name_without_ext = os.path.splitext(base_name)[0]\\n",
    "        ext = os.path.splitext(base_name)[1]\\n",
    "        new_filename = f\\"{name_without_ext} - {reviewer_name} - ç¯©é¸ç‰ˆ{ext}\\"\\n",
    "        dst_path = os.path.join(reviewer_folder, new_filename)\\n",
    "        \\n",
    "        # ç›´æ¥è¤‡è£½æª”æ¡ˆ\\n",
    "        shutil.copy2(file_path, dst_path)\\n",
    "        print(f\\"  âœ“ å·²è¤‡è£½æª”æ¡ˆ: {new_filename}\\")\\n",
    "        \\n",
    "        # åƒ…è¨­å®šç¯©é¸ï¼Œå®Œå…¨ä¸ä¿®æ”¹è³‡æ–™\\n",
    "        wb = load_workbook(dst_path, data_only=False, keep_vba=True, keep_links=True)\\n",
    "        main_ws = wb.active\\n",
    "        \\n",
    "        # å°‹æ‰¾å¯©æŸ¥è€…æ¬„ä½\\n",
    "        col_idx = find_column(main_ws, column_name)\\n",
    "        \\n",
    "        # åƒ…è¨­å®šè‡ªå‹•ç¯©é¸\\n",
    "        if main_ws.max_row > 1:\\n",
    "            try:\\n",
    "                filter_range = f\\"A1:{get_column_letter(main_ws.max_column)}{main_ws.max_row}\\"\\n",
    "                main_ws.auto_filter.ref = filter_range\\n",
    "                main_ws.auto_filter.add_filter_column(col_idx - 1, [str(reviewer)])\\n",
    "                print(f\\"  âœ“ å·²è¨­å®šç¯©é¸ï¼Œä¿æŒæ‰€æœ‰è³‡æ–™å®Œæ•´\\")\\n",
    "            except Exception as e:\\n",
    "                print(f\\"  âš ï¸ ç¯©é¸è¨­å®šå¤±æ•—: {e}\\")\\n",
    "        \\n",
    "        # å„²å­˜\\n",
    "        wb.save(dst_path)\\n",
    "        wb.close()\\n",
    "        \\n",
    "        # é©—è­‰\\n",
    "        validation, error = validate_excel_file(dst_path)\\n",
    "        if error:\\n",
    "            print(f\\"  âŒ æª”æ¡ˆé©—è­‰å¤±æ•—: {error}\\")\\n",
    "            return False, None, None\\n",
    "        else:\\n",
    "            print(f\\"  âœ… æª”æ¡ˆé©—è­‰é€šé\\")\\n",
    "        \\n",
    "        return True, reviewer_folder, new_filename\\n",
    "        \\n",
    "    except Exception as e:\\n",
    "        print(f\\"âŒ æœ€å®‰å…¨è™•ç†å¤±æ•— {reviewer}: {str(e)}\\")\\n",
    "        return False, None, None"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## ğŸ›ï¸ ä½¿ç”¨è€…ä»‹é¢ï¼ˆä¿®æ­£ç‰ˆï¼‰"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "source": [
    "# æª”æ¡ˆé¸æ“‡\\n",
    "display(HTML(\\"<h3>ğŸ“ æ­¥é©Ÿ 1: æª”æ¡ˆé¸æ“‡</h3>\\"))\\n",
    "\\n",
    "def select_excel_file():\\n",
    "    global last_folder\\n",
    "    if not TKINTER_AVAILABLE:\\n",
    "        print(\\"âŒ æª”æ¡ˆå°è©±æ¡†ä¸å¯ç”¨ï¼Œè«‹æ‰‹å‹•è¼¸å…¥æª”æ¡ˆè·¯å¾‘\\")\\n",
    "        return\\n",
    "    \\n",
    "    try:\\n",
    "        root = tk.Tk()\\n",
    "        root.withdraw()\\n",
    "        root.lift()\\n",
    "        root.attributes('-topmost', True)\\n",
    "        \\n",
    "        file_path = filedialog.askopenfilename(\\n",
    "            title=\\"é¸æ“‡ Excel æª”æ¡ˆ\\",\\n",
    "            filetypes=[(\\"Excel æª”æ¡ˆ\\", \\"*.xlsx *.xls\\"), (\\"æ‰€æœ‰æª”æ¡ˆ\\", \\"*.*\\")],\\n",
    "            initialdir=last_folder\\n",
    "        )\\n",
    "        \\n",
    "        root.destroy()\\n",
    "        \\n",
    "        if file_path:\\n",
    "            excel_file_input.value = file_path\\n",
    "            last_folder = os.path.dirname(file_path)\\n",
    "            output_folder_input.value = os.path.dirname(file_path)\\n",
    "            \\n",
    "            # ğŸ” é å…ˆé©—è­‰æª”æ¡ˆ\\n",
    "            with output:\\n",
    "                clear_output()\\n",
    "                print(f\\"âœ“ å·²é¸æ“‡: {os.path.basename(file_path)}\\")\\n",
    "                print(f\\"ğŸ” æ­£åœ¨é©—è­‰æª”æ¡ˆ...\\")\\n",
    "                \\n",
    "                validation, error = validate_excel_file(file_path)\\n",
    "                if error:\\n",
    "                    print(f\\"âŒ æª”æ¡ˆé©—è­‰å¤±æ•—: {error}\\")\\n",
    "                    print(\\"âš ï¸ æ­¤æª”æ¡ˆå¯èƒ½æœ‰æ ¼å¼å•é¡Œï¼Œå»ºè­°æª¢æŸ¥\\")\\n",
    "                else:\\n",
    "                    print(f\\"âœ… æª”æ¡ˆé©—è­‰é€šéï¼Œå¯ä»¥å®‰å…¨è™•ç†\\")\\n",
    "                    print(f\\"ğŸ“Š æª”æ¡ˆè³‡è¨Š: {validation['has_data']} è¡Œè³‡æ–™\\")\\n",
    "            \\n",
    "    except Exception as e:\\n",
    "        print(f\\"âŒ é¸æ“‡æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤: {str(e)}\\")\\n",
    "\\n",
    "excel_file_input = widgets.Text(\\n",
    "    value='',\\n",
    "    placeholder='é¸æ“‡ Excel æª”æ¡ˆ...',\\n",
    "    description='Excel æª”æ¡ˆ:',\\n",
    "    layout=widgets.Layout(width='450px')\\n",
    ")\\n",
    "\\n",
    "browse_button = widgets.Button(\\n",
    "    description='ç€è¦½...',\\n",
    "    layout=widgets.Layout(width='100px')\\n",
    ")\\n",
    "\\n",
    "browse_button.on_click(lambda x: select_excel_file())\\n",
    "\\n",
    "reviewer_column_input = widgets.Text(\\n",
    "    value='Reviewer',\\n",
    "    description='å¯©æŸ¥è€…æ¬„ä½:',\\n",
    "    layout=widgets.Layout(width='300px')\\n",
    ")\\n",
    "\\n",
    "output_folder_input = widgets.Text(\\n",
    "    value='',\\n",
    "    placeholder='è¼¸å‡ºè³‡æ–™å¤¾ï¼ˆé è¨­ç‚º Excel æª”æ¡ˆæ‰€åœ¨è³‡æ–™å¤¾ï¼‰',\\n",
    "    description='è¼¸å‡ºè³‡æ–™å¤¾:',\\n",
    "    layout=widgets.Layout(width='450px')\\n",
    ")\\n",
    "\\n",
    "display(widgets.HBox([excel_file_input, browse_button]))\\n",
    "display(reviewer_column_input)\\n",
    "display(output_folder_input)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "source": [
    "# ğŸš¨ ä¿®æ­£ç‰ˆé¸é …è¨­å®š\\n",
    "display(HTML(\\"<h3>âš™ï¸ æ­¥é©Ÿ 2: è™•ç†æ–¹æ³•é¸æ“‡</h3>\\"))\\n",
    "\\n",
    "processing_method = widgets.RadioButtons(\\n",
    "    options=[\\n",
    "        ('éš±è—åˆ—æ–¹æ³•ï¼ˆæ¨è–¦ï¼Œè§£æ±ºæ ¼å¼å•é¡Œï¼‰', 'hide_rows'),\\n",
    "        ('æœ€å®‰å…¨æ–¹æ³•ï¼ˆåƒ…ç¯©é¸ï¼Œä¿æŒå®Œæ•´ï¼‰', 'minimal_safe')\\n",
    "    ],\\n",
    "    value='hide_rows',\\n",
    "    description='è™•ç†æ–¹æ³•:'\\n",
    ")\\n",
    "\\n",
    "copy_word_check = widgets.Checkbox(\\n",
    "    value=True,\\n",
    "    description='è¤‡è£½ Word æ–‡ä»¶ (.doc, .docx)'\\n",
    ")\\n",
    "\\n",
    "copy_pdf_check = widgets.Checkbox(\\n",
    "    value=True,\\n",
    "    description='è¤‡è£½ PDF æ–‡ä»¶ (.pdf)'\\n",
    ")\\n",
    "\\n",
    "display(processing_method)\\n",
    "display(copy_word_check)\\n",
    "display(copy_pdf_check)\\n",
    "\\n",
    "# èªªæ˜\\n",
    "display(HTML(\\"\\"\\"\\n",
    "<div style='background-color: #e8f4fd; padding: 15px; margin: 10px 0; border-left: 4px solid #2196F3;'>\\n",
    "<h4>ğŸ”§ è™•ç†æ–¹æ³•èªªæ˜</h4>\\n",
    "<ul>\\n",
    "<li><b>éš±è—åˆ—æ–¹æ³•</b>ï¼šéš±è—ä¸ç›¸é—œçš„è³‡æ–™åˆ—ï¼Œä¿æŒæª”æ¡ˆçµæ§‹å®Œæ•´ï¼Œè§£æ±ºæ ¼å¼éŒ¯èª¤å•é¡Œ</li>\\n",
    "<li><b>æœ€å®‰å…¨æ–¹æ³•</b>ï¼šåƒ…è¨­å®šç¯©é¸æ¢ä»¶ï¼Œå®Œå…¨ä¸ä¿®æ”¹è³‡æ–™ï¼Œé©ç”¨æ–¼è¤‡é›œçš„ Excel æª”æ¡ˆ</li>\\n",
    "</ul>\\n",
    "</div>\\n",
    "\\"\\\"\\\"))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "source": [
    "# è™•ç†æŒ‰éˆ•å’Œè¼¸å‡º\\n",
    "process_button = widgets.Button(\\n",
    "    description='ğŸš€ é–‹å§‹è™•ç†',\\n",
    "    button_style='success',\\n",
    "    layout=widgets.Layout(width='200px', height='40px')\\n",
    ")\\n",
    "\\n",
    "output = widgets.Output()\\n",
    "\\n",
    "display(HTML(\\"<br>\\"))\\n",
    "display(process_button)\\n",
    "display(output)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "source": [
    "def process_excel_file_fixed(button):\\n",
    "    \\"\\"\\"ğŸš¨ ä¿®æ­£ç‰ˆä¸»è¦è™•ç†å‡½æ•¸\\"\\"\\"\\n",
    "    with output:\\n",
    "        clear_output()\\n",
    "        \\n",
    "        # é©—è­‰è¼¸å…¥\\n",
    "        if not excel_file_input.value:\\n",
    "            print(\\"âŒ è«‹é¸æ“‡ Excel æª”æ¡ˆ\\")\\n",
    "            return\\n",
    "        \\n",
    "        file_path = excel_file_input.value.strip()\\n",
    "        column_name = reviewer_column_input.value.strip()\\n",
    "        output_folder = output_folder_input.value.strip() or os.path.dirname(file_path)\\n",
    "        method = processing_method.value\\n",
    "        \\n",
    "        if not os.path.exists(file_path):\\n",
    "            print(f\\"âŒ æ‰¾ä¸åˆ°æª”æ¡ˆ: {file_path}\\")\\n",
    "            return\\n",
    "        \\n",
    "        print(f\\"ğŸ“ è™•ç†æª”æ¡ˆ: {os.path.basename(file_path)}\\")\\n",
    "        print(f\\"ğŸ“Š å¯©æŸ¥è€…æ¬„ä½: {column_name}\\")\\n",
    "        print(f\\"ğŸ“‚ è¼¸å‡ºè³‡æ–™å¤¾: {output_folder}\\")\\n",
    "        print(f\\"ğŸ”§ è™•ç†æ–¹æ³•: {method}\\")\\n",
    "        print(\\"=\\" * 60)\\n",
    "        \\n",
    "        # ğŸ” é å…ˆé©—è­‰æª”æ¡ˆ\\n",
    "        print(\\"ğŸ” é©—è­‰è¼¸å…¥æª”æ¡ˆ...\\")\\n",
    "        validation, error = validate_excel_file(file_path)\\n",
    "        if error:\\n",
    "            print(f\\"âŒ è¼¸å…¥æª”æ¡ˆé©—è­‰å¤±æ•—: {error}\\")\\n",
    "            print(\\"âš ï¸ å»ºè­°æª¢æŸ¥åŸå§‹æª”æ¡ˆæ˜¯å¦æœ‰å•é¡Œ\\")\\n",
    "            return\\n",
    "        else:\\n",
    "            print(\\"âœ… è¼¸å…¥æª”æ¡ˆé©—è­‰é€šé\\")\\n",
    "        \\n",
    "        start_time = time.time()\\n",
    "        \\n",
    "        try:\\n",
    "            # è®€å– Excel\\n",
    "            df = pd.read_excel(file_path, engine='openpyxl')\\n",
    "            \\n",
    "            if column_name not in df.columns:\\n",
    "                print(f\\"âŒ æ‰¾ä¸åˆ°æ¬„ä½ '{column_name}'\\")\\n",
    "                print(f\\"å¯ç”¨æ¬„ä½: {', '.join(df.columns)}\\")\\n",
    "                return\\n",
    "            \\n",
    "            reviewers = df[column_name].dropna().unique().tolist()\\n",
    "            print(f\\"âœ“ æ‰¾åˆ° {len(reviewers)} ä½å¯©æŸ¥è€…\\")\\n",
    "            \\n",
    "            # é€²åº¦æ¢\\n",
    "            progress = widgets.IntProgress(\\n",
    "                value=0,\\n",
    "                min=0,\\n",
    "                max=len(reviewers),\\n",
    "                description='é€²åº¦:',\\n",
    "                bar_style='info'\\n",
    "            )\\n",
    "            display(progress)\\n",
    "            \\n",
    "            processed = 0\\n",
    "            failed = 0\\n",
    "            \\n",
    "            for i, reviewer in enumerate(reviewers):\\n",
    "                print(f\\"\\\\nğŸ“ è™•ç† {reviewer} ({i+1}/{len(reviewers)})\\")\\n",
    "                \\n",
    "                # æ ¹æ“šæ–¹æ³•é¸æ“‡è™•ç†å‡½æ•¸\\n",
    "                if method == 'minimal_safe':\\n",
    "                    success, folder_path, filename = process_reviewer_excel_minimal_safe(\\n",
    "                        file_path, reviewer, column_name, output_folder\\n",
    "                    )\\n",
    "                else:  # hide_rows\\n",
    "                    success, folder_path, filename = process_reviewer_excel_hide_rows_safe(\\n",
    "                        file_path, reviewer, column_name, output_folder\\n",
    "                    )\\n",
    "                \\n",
    "                if success:\\n",
    "                    # è¤‡è£½ç›¸é—œæ–‡ä»¶\\n",
    "                    if copy_word_check.value or copy_pdf_check.value:\\n",
    "                        copied = copy_selected_documents(\\n",
    "                            os.path.dirname(file_path), folder_path,\\n",
    "                            copy_word=copy_word_check.value,\\n",
    "                            copy_pdf=copy_pdf_check.value\\n",
    "                        )\\n",
    "                        if copied:\\n",
    "                            print(f\\"  âœ“ å·²è¤‡è£½ {len(copied)} å€‹æ–‡ä»¶\\")\\n",
    "                    \\n",
    "                    processed += 1\\n",
    "                else:\\n",
    "                    failed += 1\\n",
    "                \\n",
    "                progress.value = i + 1\\n",
    "            \\n",
    "            elapsed_time = time.time() - start_time\\n",
    "            \\n",
    "            # ç¸½çµ\\n",
    "            print(f\\"\\\\n{\\"=\\" * 60}\\")\\n",
    "            print(f\\"âœ… è™•ç†å®Œæˆï¼\\")\\n",
    "            print(f\\"ğŸ“Š æˆåŠŸ: {processed}/{len(reviewers)} ä½å¯©æŸ¥è€…\\")\\n",
    "            if failed > 0:\\n",
    "                print(f\\"âŒ å¤±æ•—: {failed} ä½\\")\\n",
    "            print(f\\"â±ï¸ è™•ç†æ™‚é–“: {elapsed_time:.1f} ç§’\\")\\n",
    "            print(f\\"ğŸ“ è¼¸å‡ºä½ç½®: {output_folder}\\")\\n",
    "            \\n",
    "            if processed > 0:\\n",
    "                print(f\\"\\\\nğŸ‰ ä¿®æ­£æˆåŠŸï¼æª”æ¡ˆæ‡‰è©²å¯ä»¥æ­£å¸¸é–‹å•Ÿäº†\\")\\n",
    "                print(f\\"ğŸ’¡ å¦‚æœé‚„æœ‰å•é¡Œï¼Œè«‹å˜—è©¦'æœ€å®‰å…¨æ–¹æ³•'é¸é …\\")\\n",
    "            \\n",
    "        except Exception as e:\\n",
    "            print(f\\"\\\\nâŒ è™•ç†éç¨‹ç™¼ç”ŸéŒ¯èª¤: {str(e)}\\")\\n",
    "            import traceback\\n",
    "            traceback.print_exc()\\n",
    "\\n",
    "# é€£æ¥è™•ç†å‡½æ•¸\\n",
    "process_button.on_click(process_excel_file_fixed)\\n",
    "print(\\"âœ… ä¿®æ­£ç‰ˆè™•ç†ç³»çµ±å·²å°±ç·’\\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## ğŸ“‹ ä½¿ç”¨èªªæ˜ï¼ˆä¿®æ­£ç‰ˆï¼‰\\n",
    "\\n",
    "### ğŸš¨ ä¸»è¦ä¿®æ­£å…§å®¹\\n",
    "\\n",
    "1. **è§£æ±ºæª”æ¡ˆæ ¼å¼å•é¡Œ**\\n",
    "   - ä½¿ç”¨éš±è—åˆ—æ›¿ä»£åˆªé™¤åˆ—\\n",
    "   - ä¿æŒæª”æ¡ˆçµæ§‹å®Œæ•´æ€§\\n",
    "   - é¿å…ç ´å£è³‡æ–™é©—è­‰è¦å‰‡\\n",
    "\\n",
    "2. **åŠ å¼·æª”æ¡ˆé©—è­‰**\\n",
    "   - è™•ç†å‰å¾Œéƒ½é€²è¡Œæª”æ¡ˆé©—è­‰\\n",
    "   - ç¢ºä¿è¼¸å‡ºæª”æ¡ˆå¯æ­£å¸¸é–‹å•Ÿ\\n",
    "   - è©³ç´°çš„éŒ¯èª¤è¿½è¹¤\\n",
    "\\n",
    "3. **æä¾›å¤šç¨®è™•ç†æ–¹æ³•**\\n",
    "   - éš±è—åˆ—æ–¹æ³•ï¼šè§£æ±ºå¤§éƒ¨åˆ†æ ¼å¼å•é¡Œ\\n",
    "   - æœ€å®‰å…¨æ–¹æ³•ï¼šé©ç”¨æ–¼è¤‡é›œæª”æ¡ˆ\\n",
    "\\n",
    "### ğŸ”§ è™•ç†æ–¹æ³•æ¯”è¼ƒ\\n",
    "\\n",
    "| æ–¹æ³• | æª”æ¡ˆå¤§å° | å®‰å…¨æ€§ | ç›¸å®¹æ€§ | æ¨è–¦å ´æ™¯ |\\n",
    "|------|----------|--------|--------|----------|\\n",
    "| éš±è—åˆ— | ä¸è®Š | é«˜ | æ¥µé«˜ | ä¸€èˆ¬ä½¿ç”¨ |\\n",
    "| æœ€å®‰å…¨ | ä¸è®Š | æ¥µé«˜ | 100% | è¤‡é›œæª”æ¡ˆ |\\n",
    "| ~~åˆªé™¤åˆ—~~ | ~~æ¸›å°‘~~ | ~~ä½~~ | ~~å·®~~ | ~~ä¸æ¨è–¦~~ |\\n",
    "\\n",
    "### ğŸš€ å¿«é€Ÿé–‹å§‹\\n",
    "\\n",
    "1. é¸æ“‡æœ‰å•é¡Œçš„ Excel æª”æ¡ˆ\\n",
    "2. ç¢ºèªå¯©æŸ¥è€…æ¬„ä½åç¨±\\n",
    "3. é¸æ“‡è™•ç†æ–¹æ³•ï¼ˆæ¨è–¦ï¼šéš±è—åˆ—ï¼‰\\n",
    "4. é»æ“Šé–‹å§‹è™•ç†\\n",
    "5. æª¢æŸ¥è¼¸å‡ºæª”æ¡ˆæ˜¯å¦å¯æ­£å¸¸é–‹å•Ÿ\\n",
    "\\n",
    "### ğŸ’¡ ç–‘é›£æ’è§£\\n",
    "\\n",
    "**å¦‚æœä»ç„¶ç„¡æ³•é–‹å•Ÿæª”æ¡ˆï¼š**\\n",
    "1. å˜—è©¦ã€Œæœ€å®‰å…¨æ–¹æ³•ã€\\n",
    "2. æª¢æŸ¥åŸå§‹æª”æ¡ˆæ˜¯å¦æœ‰å•é¡Œ\\n",
    "3. ç¢ºèª Excel ç‰ˆæœ¬ç›¸å®¹æ€§\\n",
    "4. è€ƒæ…®ä½¿ç”¨ä¸åŒçš„ Excel æ‡‰ç”¨ç¨‹å¼é–‹å•Ÿ\\n",
    "\\n",
    "**å¸¸è¦‹å•é¡Œï¼š**\\n",
    "- è³‡æ–™é©—è­‰å¤±æ•ˆ â†’ å·²ä¿®æ­£ï¼Œç¾åœ¨æœƒä¿ç•™\\n",
    "- æ¢ä»¶æ ¼å¼æ¶ˆå¤± â†’ ä½¿ç”¨éš±è—åˆ—æ–¹æ³•å¯é¿å…\\n",
    "- å…¬å¼åƒç…§éŒ¯èª¤ â†’ ä¸å†åˆªé™¤åˆ—ï¼Œå•é¡Œè§£æ±º\\n",
    "- åˆä½µå„²å­˜æ ¼å•é¡Œ â†’ æª”æ¡ˆçµæ§‹ä¿æŒå®Œæ•´"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.8.5"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
"""
    
    return notebook_content

# åŸ·è¡Œå»ºç«‹å‡½æ•¸
if __name__ == "__main__":
    content = create_jupyter_notebook_fixed()
    
    # å¯«å…¥æª”æ¡ˆ
    output_path = "/Users/davidshih/projects/excel/excel_splitter_onedrive_fixed.ipynb"
    with open(output_path, 'w', encoding='utf-8') as f:
        f.write(content)
    
    print(f"âœ… ä¿®æ­£ç‰ˆ Jupyter notebook å·²å»ºç«‹: {output_path}")
    print("ğŸš¨ ä¸»è¦ä¿®æ­£å…§å®¹ï¼š")
    print("  - ä½¿ç”¨éš±è—åˆ—æ›¿ä»£åˆªé™¤åˆ—")
    print("  - ä¿æŒæª”æ¡ˆçµæ§‹å®Œæ•´æ€§")
    print("  - åŠ å¼·æª”æ¡ˆé©—è­‰æ©Ÿåˆ¶")
    print("  - æä¾›å¤šç¨®è™•ç†æ–¹æ³•é¸æ“‡")