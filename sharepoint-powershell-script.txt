# SharePoint è³‡æ–™å¤¾åˆ†äº«å·¥å…· (PowerShell ç‰ˆ)
# ä¸éœ€è¦ç®¡ç†å“¡æ¬Šé™ï¼æ”¯æ´ SSO + MFAï¼
# å°±åƒç”¨å“¡å·¥è­‰åˆ·å¡é€²å…¬å¸ä¸€æ¨£ç°¡å–®ï¼

# ===== è¼‰å…¥è¨­å®šæª” =====
$configPath = Join-Path $PSScriptRoot "SharePoint_Config.ps1"
if (Test-Path $configPath) {
    . $configPath
} else {
    Write-Host "âŒ æ‰¾ä¸åˆ°è¨­å®šæª”ï¼šSharePoint_Config.ps1" -ForegroundColor Red
    Write-Host "   è«‹ç¢ºèªæª”æ¡ˆå­˜åœ¨æ–¼ç›¸åŒç›®éŒ„" -ForegroundColor Yellow
    exit 1
}

# å¾è¨­å®šæª”å–å¾—å€¼
$SiteUrl = $Global:SharePointConfig.SiteUrl
$FolderBasePath = $Global:SharePointConfig.FolderBasePath
$LogFile = $Global:SharePointConfig.LogFile

# ===== å‡½å¼å€åŸŸ =====

function Write-ColorOutput {
    param(
        [string]$Message,
        [string]$Color = "White"
    )
    Write-Host $Message -ForegroundColor $Color
    Add-Content -Path $LogFile -Value "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') - $Message"
}

function Connect-ToSharePoint {
    param(
        [string]$Url
    )
    
    Write-ColorOutput "ğŸ” é€£æ¥åˆ° SharePoint..." "Yellow"
    Write-ColorOutput "   æ”¯æ´ SSO å’Œ MFAï¼" "Gray"
    
    try {
        # æª¢æŸ¥æ˜¯å¦å·²å®‰è£ PnP PowerShell
        if (!(Get-Module -ListAvailable -Name "PnP.PowerShell")) {
            Write-ColorOutput "ğŸ“¦ éœ€è¦å®‰è£ PnP PowerShell æ¨¡çµ„..." "Yellow"
            Write-ColorOutput "   é€™ä¸éœ€è¦ç®¡ç†å“¡æ¬Šé™ï¼" "Gray"
            
            # å…ˆè¨­å®š PSGallery ç‚ºä¿¡ä»»çš„ä¾†æº
            try {
                Set-PSRepository -Name 'PSGallery' -InstallationPolicy Trusted -ErrorAction SilentlyContinue
            }
            catch {
                Write-ColorOutput "   ç„¡æ³•è¨­å®š PSGalleryï¼ˆæ²’é—œä¿‚ï¼Œç¹¼çºŒå®‰è£ï¼‰" "Gray"
            }
            
            # å®‰è£åˆ°ä½¿ç”¨è€…ç¯„åœï¼ˆä¸éœ€è¦ç®¡ç†å“¡ï¼‰
            try {
                Install-Module -Name "PnP.PowerShell" -Scope CurrentUser -Force -AllowClobber -SkipPublisherCheck -ErrorAction Stop
                Write-ColorOutput "âœ… æ¨¡çµ„å®‰è£å®Œæˆï¼" "Green"
            }
            catch {
                Write-ColorOutput "   æ¨™æº–å®‰è£å¤±æ•—ï¼Œå˜—è©¦å…¶ä»–æ–¹æ³•..." "Yellow"
                
                # æ–¹æ³• 2: ä½¿ç”¨ -Repository åƒæ•¸
                try {
                    Install-Module -Name "PnP.PowerShell" -Repository PSGallery -Scope CurrentUser -Force -AllowClobber -ErrorAction Stop
                    Write-ColorOutput "âœ… æ¨¡çµ„å®‰è£å®Œæˆï¼" "Green"
                }
                catch {
                    Write-ColorOutput "   âš ï¸  è‡ªå‹•å®‰è£å¤±æ•—ï¼Œè«‹æ‰‹å‹•å®‰è£ï¼š" "Yellow"
                    Write-ColorOutput "   1. é–‹å•Ÿ PowerShell (ä¸éœ€è¦ç®¡ç†å“¡)" "Gray"
                    Write-ColorOutput "   2. åŸ·è¡Œ: Install-Module -Name PnP.PowerShell -Scope CurrentUser -Force -AllowClobber" "Gray"
                    Write-ColorOutput "   3. å¦‚æœå‡ºç¾æç¤ºï¼Œé¸æ“‡ [Y] æˆ– [A]" "Gray"
                    Read-Host "`n   å®Œæˆå¾ŒæŒ‰ Enter ç¹¼çºŒ"
                }
            }
        }
        
        # åŒ¯å…¥æ¨¡çµ„
        Import-Module PnP.PowerShell -ErrorAction Stop
        
        # é€£æ¥ï¼ˆæœƒé–‹å•Ÿç€è¦½å™¨é€²è¡Œ SSO + MFAï¼‰
        Connect-PnPOnline -Url $Url -Interactive
        
        Write-ColorOutput "âœ… æˆåŠŸé€£æ¥åˆ° SharePointï¼" "Green"
        return $true
    }
    catch {
        Write-ColorOutput "âŒ é€£æ¥å¤±æ•—ï¼š$($_.Exception.Message)" "Red"
        return $false
    }
}

function Find-SharePointUser {
    param(
        [string]$DisplayName
    )
    
    Write-ColorOutput "`nğŸ” æœå°‹ä½¿ç”¨è€…ï¼š$DisplayName" "Cyan"
    
    try {
        # å–å¾—æ‰€æœ‰ä½¿ç”¨è€…
        $users = Get-PnPUser | Where-Object { 
            $_.Title -like "*$DisplayName*" -or 
            $_.Email -like "*$DisplayName*" 
        }
        
        if ($users.Count -eq 0) {
            Write-ColorOutput "   âŒ æ‰¾ä¸åˆ°ä½¿ç”¨è€…" "Red"
            return $null
        }
        elseif ($users.Count -eq 1) {
            Write-ColorOutput "   âœ… æ‰¾åˆ°ä½¿ç”¨è€…ï¼š$($users[0].Title) ($($users[0].Email))" "Green"
            return $users[0]
        }
        else {
            Write-ColorOutput "   æ‰¾åˆ°å¤šå€‹ä½¿ç”¨è€…ï¼š" "Yellow"
            $i = 1
            foreach ($user in $users) {
                Write-Host "     $i. $($user.Title) - $($user.Email)"
                $i++
            }
            
            $choice = Read-Host "`n   è«‹é¸æ“‡ (è¼¸å…¥ç·¨è™Ÿ)"
            if ($choice -match '^\d+$' -and [int]$choice -le $users.Count) {
                return $users[[int]$choice - 1]
            }
            else {
                Write-ColorOutput "   âŒ ç„¡æ•ˆçš„é¸æ“‡" "Red"
                return $null
            }
        }
    }
    catch {
        Write-ColorOutput "   âŒ æœå°‹éŒ¯èª¤ï¼š$($_.Exception.Message)" "Red"
        return $null
    }
}

function Share-SingleFolder {
    param(
        [string]$FolderPath,
        [string]$FolderName,
        [string]$Permission = $Global:SharePointConfig.DefaultPermission
    )
    
    Write-ColorOutput "`nğŸ“ è™•ç†è³‡æ–™å¤¾ï¼š$FolderName" "Yellow"
    
    $fullPath = $FolderPath + $FolderName
    Write-ColorOutput "   è·¯å¾‘ï¼š$fullPath" "Gray"
    
    # æª¢æŸ¥ä½¿ç”¨è€…å°æ‡‰
    $targetUser = $null
    if ($Global:UserMapping.ContainsKey($FolderName)) {
        $mappedEmail = $Global:UserMapping[$FolderName]
        Write-ColorOutput "   ä½¿ç”¨å°æ‡‰è¨­å®šï¼š$mappedEmail" "Cyan"
        try {
            $targetUser = Get-PnPUser | Where-Object { $_.Email -eq $mappedEmail }
            if ($targetUser) {
                Write-ColorOutput "   âœ… æ‰¾åˆ°å°æ‡‰ä½¿ç”¨è€…ï¼š$($targetUser.Title)" "Green"
            }
        }
        catch {
            Write-ColorOutput "   âŒ æ‰¾ä¸åˆ°å°æ‡‰çš„ä½¿ç”¨è€…" "Red"
        }
    }
    
    # å¦‚æœæ²’æœ‰å°æ‡‰æˆ–æ‰¾ä¸åˆ°ï¼Œä½¿ç”¨åŸæœ¬çš„æœå°‹
    if (-not $targetUser) {
        # å°‹æ‰¾åŒåä½¿ç”¨è€…
        $user = Find-SharePointUser -DisplayName $FolderName
        
        if (-not $user) {
            # æ‰‹å‹•è¼¸å…¥
            Write-Host "`nğŸ’¡ æ‰¾ä¸åˆ°åŒåä½¿ç”¨è€…" -ForegroundColor Yellow
            $email = Read-Host "   è«‹è¼¸å…¥ä½¿ç”¨è€… email (æˆ–æŒ‰ Enter è·³é)"
            
            if ($email) {
                try {
                    $user = Get-PnPUser | Where-Object { $_.Email -eq $email }
                    if (-not $user) {
                        Write-ColorOutput "   âŒ æ‰¾ä¸åˆ°æ­¤ email çš„ä½¿ç”¨è€…" "Red"
                        return $false
                    }
                }
                catch {
                    Write-ColorOutput "   âŒ éŒ¯èª¤ï¼š$($_.Exception.Message)" "Red"
                    return $false
                }
            }
            else {
                return $false
            }
        }
        $targetUser = $user
    }
    
    # ç¢ºèªåˆ†äº«ï¼ˆé™¤éè¨­å®šè‡ªå‹•ç¢ºèªï¼‰
    if (-not $Global:SharePointConfig.AutoConfirm) {
        $confirm = Read-Host "`nç¢ºå®šè¦åˆ†äº«çµ¦ $($targetUser.Title) å—ï¼Ÿ(Y/n)"
        if ($confirm -eq 'n') {
            Write-ColorOutput "   å·²å–æ¶ˆåˆ†äº«" "Yellow"
            return $false
        }
    }
    
    # åˆ†äº«è³‡æ–™å¤¾
    try {
        Write-ColorOutput "   ğŸ“¤ åˆ†äº«ä¸­..." "Gray"
        
        # æ–¹æ³• 1: ä½¿ç”¨ Set-PnPFolderPermission
        Set-PnPFolderPermission -List "Documents" -Identity $fullPath `
            -User $targetUser.LoginName -AddRole $Permission -ErrorAction Stop
        
        Write-ColorOutput "   âœ… æˆåŠŸåˆ†äº«çµ¦ï¼š$($targetUser.Title)" "Green"
        Write-ColorOutput "   æ¬Šé™ï¼š$Permission" "Gray"
        
        # æ‰¹æ¬¡è™•ç†å»¶é²
        if ($Global:SharePointConfig.BatchDelay -gt 0) {
            Start-Sleep -Seconds $Global:SharePointConfig.BatchDelay
        }
        
        return $true
    }
    catch {
        # å¦‚æœæ–¹æ³• 1 å¤±æ•—ï¼Œå˜—è©¦æ–¹æ³• 2
        try {
            Write-ColorOutput "   å˜—è©¦æ›¿ä»£æ–¹æ³•..." "Yellow"
            
            # å–å¾—è³‡æ–™å¤¾é …ç›®
            $folder = Get-PnPFolder -Url $fullPath -Includes ListItemAllFields
            $listItem = $folder.ListItemAllFields
            
            # æŒ‡æ´¾æ¬Šé™
            Set-PnPListItemPermission -List "Documents" -Identity $listItem.Id `
                -User $user.LoginName -AddRole $Permission
            
            Write-ColorOutput "   âœ… æˆåŠŸåˆ†äº«çµ¦ï¼š$($user.Title)" "Green"
            return $true
        }
        catch {
            Write-ColorOutput "   âŒ åˆ†äº«å¤±æ•—ï¼š$($_.Exception.Message)" "Red"
            return $false
        }
    }
}

function Start-BatchShare {
    param(
        [string[]]$FolderNames
    )
    
    Write-ColorOutput "`nğŸ“¦ æ‰¹æ¬¡åˆ†äº«æ¨¡å¼" "Cyan"
    Write-ColorOutput "   æº–å‚™è™•ç† $($FolderNames.Count) å€‹è³‡æ–™å¤¾" "Gray"
    Write-ColorOutput ("=" * 50) "Gray"
    
    $successCount = 0
    $failedFolders = @()
    
    for ($i = 0; $i -lt $FolderNames.Count; $i++) {
        $folderName = $FolderNames[$i]
        Write-ColorOutput "`n[$($i+1)/$($FolderNames.Count)] è™•ç†ä¸­..." "Yellow"
        
        if (Share-SingleFolder -FolderPath $FolderBasePath -FolderName $folderName) {
            $successCount++
        }
        else {
            $failedFolders += $folderName
        }
    }
    
    # é¡¯ç¤ºçµæœ
    Write-ColorOutput "`n" "White"
    Write-ColorOutput ("=" * 50) "Gray"
    Write-ColorOutput "ğŸ“Š æ‰¹æ¬¡è™•ç†çµæœï¼š" "Cyan"
    Write-ColorOutput "   æˆåŠŸï¼š$successCount/$($FolderNames.Count)" "Green"
    
    if ($failedFolders.Count -gt 0) {
        Write-ColorOutput "`nâŒ å¤±æ•—çš„é …ç›®ï¼š" "Red"
        foreach ($folder in $failedFolders) {
            Write-ColorOutput "   - $folder" "Red"
        }
    }
    
    Write-ColorOutput "`nâœ… è™•ç†å®Œæˆï¼" "Green"
}

function Start-InteractiveMode {
    Write-ColorOutput "ğŸ¯ SharePoint è³‡æ–™å¤¾åˆ†äº«å·¥å…· (äº’å‹•æ¨¡å¼)" "Cyan"
    Write-ColorOutput ("=" * 50) "Gray"
    Write-ColorOutput "ç¶²ç«™: $SiteUrl" "Gray"
    Write-ColorOutput "è·¯å¾‘: $FolderBasePath" "Gray"
    Write-ColorOutput ("=" * 50) "Gray"
    
    # é€£æ¥åˆ° SharePoint
    if (-not (Connect-ToSharePoint -Url $SiteUrl)) {
        return
    }
    
    while ($true) {
        Write-Host "`n" -NoNewline
        Write-ColorOutput "é¸æ“‡æ“ä½œæ¨¡å¼ï¼š" "Yellow"
        Write-Host "  1. å–®ä¸€è³‡æ–™å¤¾åˆ†äº«"
        Write-Host "  2. æ‰¹æ¬¡åˆ†äº« (å¾æª”æ¡ˆè®€å–)"
        Write-Host "  3. æ‰¹æ¬¡åˆ†äº« (æ‰‹å‹•è¼¸å…¥)"
        Write-Host "  4. æ¸¬è©¦é€£ç·š"
        
        # å¦‚æœæœ‰è¨­å®šå¸¸ç”¨è³‡æ–™å¤¾ï¼Œé¡¯ç¤ºå¿«é€Ÿé¸é …
        if ($Global:CommonFolders.Count -gt 0) {
            Write-Host "  5. å¿«é€Ÿåˆ†äº« (å¸¸ç”¨è³‡æ–™å¤¾)"
        }
        
        Write-Host "  Q. çµæŸ"
        
        $choice = Read-Host "`nè«‹é¸æ“‡"
        
        switch ($choice.ToUpper()) {
            "1" {
                $folderName = Read-Host "`nè«‹è¼¸å…¥è³‡æ–™å¤¾åç¨±"
                if ($folderName) {
                    Share-SingleFolder -FolderPath $FolderBasePath -FolderName $folderName
                }
            }
            "2" {
                $filePath = Read-Host "`nè«‹è¼¸å…¥æª”æ¡ˆè·¯å¾‘ (é è¨­: $($Global:AdvancedConfig.DefaultBatchFile))"
                if ([string]::IsNullOrWhiteSpace($filePath)) {
                    $filePath = $Global:AdvancedConfig.DefaultBatchFile
                }
                
                if (Test-Path $filePath) {
                    $folders = Get-Content $filePath | Where-Object { $_.Trim() -ne "" }
                    Start-BatchShare -FolderNames $folders
                }
                else {
                    Write-ColorOutput "âŒ æ‰¾ä¸åˆ°æª”æ¡ˆ: $filePath" "Red"
                }
            }
            "3" {
                Write-Host "`nè«‹è¼¸å…¥è³‡æ–™å¤¾åç¨± (æ¯è¡Œä¸€å€‹ï¼Œè¼¸å…¥ç©ºè¡ŒçµæŸ)ï¼š"
                $folders = @()
                while ($true) {
                    $input = Read-Host
                    if ([string]::IsNullOrWhiteSpace($input)) {
                        break
                    }
                    $folders += $input
                }
                if ($folders.Count -gt 0) {
                    Start-BatchShare -FolderNames $folders
                }
            }
            "4" {
                try {
                    $web = Get-PnPWeb
                    Write-ColorOutput "`nâœ… é€£ç·šæ­£å¸¸ï¼" "Green"
                    Write-ColorOutput "   ç¶²ç«™æ¨™é¡Œï¼š$($web.Title)" "Gray"
                    Write-ColorOutput "   ç¶²å€ï¼š$($web.Url)" "Gray"
                }
                catch {
                    Write-ColorOutput "âŒ é€£ç·šæ¸¬è©¦å¤±æ•—" "Red"
                }
            }
            "5" {
                if ($Global:CommonFolders.Count -gt 0) {
                    Write-Host "`nå¸¸ç”¨è³‡æ–™å¤¾ï¼š"
                    for ($i = 0; $i -lt $Global:CommonFolders.Count; $i++) {
                        Write-Host "  $($i+1). $($Global:CommonFolders[$i])"
                    }
                    $folderChoice = Read-Host "`né¸æ“‡è³‡æ–™å¤¾ç·¨è™Ÿ"
                    if ($folderChoice -match '^\d+

# ===== ä¸»ç¨‹å¼ =====

Clear-Host
Write-ColorOutput @"
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘     SharePoint è³‡æ–™å¤¾åˆ†äº«å·¥å…· (PowerShell)      â•‘
â•‘         æ”¯æ´ SSO + MFAï¼Œä¸éœ€ç®¡ç†å“¡æ¬Šé™ï¼         â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"@ "Cyan"

# æª¢æŸ¥åƒæ•¸
if ($args.Count -eq 0) {
    # äº’å‹•æ¨¡å¼
    Start-InteractiveMode
}
else {
    # å‘½ä»¤åˆ—æ¨¡å¼
    $operation = $args[0]
    
    switch ($operation.ToLower()) {
        "share" {
            if ($args.Count -ge 2) {
                Connect-ToSharePoint -Url $SiteUrl
                Share-SingleFolder -FolderPath $FolderBasePath -FolderName $args[1]
            }
            else {
                Write-ColorOutput "ç”¨æ³•: .\SharePoint_Folder_Share.ps1 share <è³‡æ–™å¤¾åç¨±>" "Yellow"
            }
        }
        "batch" {
            if ($args.Count -ge 2 -and (Test-Path $args[1])) {
                Connect-ToSharePoint -Url $SiteUrl
                $folders = Get-Content $args[1] | Where-Object { $_.Trim() -ne "" }
                Start-BatchShare -FolderNames $folders
            }
            else {
                Write-ColorOutput "ç”¨æ³•: .\SharePoint_Folder_Share.ps1 batch <æª”æ¡ˆè·¯å¾‘>" "Yellow"
            }
        }
        default {
            Write-ColorOutput "å¯ç”¨æŒ‡ä»¤ï¼š" "Yellow"
            Write-ColorOutput "  äº’å‹•æ¨¡å¼: .\SharePoint_Folder_Share.ps1" "Gray"
            Write-ColorOutput "  å–®ä¸€åˆ†äº«: .\SharePoint_Folder_Share.ps1 share <è³‡æ–™å¤¾åç¨±>" "Gray"
            Write-ColorOutput "  æ‰¹æ¬¡åˆ†äº«: .\SharePoint_Folder_Share.ps1 batch <æª”æ¡ˆè·¯å¾‘>" "Gray"
        }
    }
}

# è¨˜éŒ„çµæŸ
Write-ColorOutput "`nåŸ·è¡Œå®Œæˆæ–¼: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" "Gray") {
                        $index = [int]$folderChoice - 1
                        if ($index -ge 0 -and $index -lt $Global:CommonFolders.Count) {
                            Share-SingleFolder -FolderPath $FolderBasePath -FolderName $Global:CommonFolders[$index]
                        }
                    }
                }
            }
            "Q" {
                Write-ColorOutput "`nğŸ‘‹ æ„Ÿè¬ä½¿ç”¨ï¼" "Cyan"
                break
            }
            default {
                Write-ColorOutput "âŒ ç„¡æ•ˆçš„é¸æ“‡" "Red"
            }
        }
    }
}

# ===== ä¸»ç¨‹å¼ =====

Clear-Host
Write-ColorOutput @"
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘     SharePoint è³‡æ–™å¤¾åˆ†äº«å·¥å…· (PowerShell)      â•‘
â•‘         æ”¯æ´ SSO + MFAï¼Œä¸éœ€ç®¡ç†å“¡æ¬Šé™ï¼         â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"@ "Cyan"

# æª¢æŸ¥åƒæ•¸
if ($args.Count -eq 0) {
    # äº’å‹•æ¨¡å¼
    Start-InteractiveMode
}
else {
    # å‘½ä»¤åˆ—æ¨¡å¼
    $operation = $args[0]
    
    switch ($operation.ToLower()) {
        "share" {
            if ($args.Count -ge 2) {
                Connect-ToSharePoint -Url $SiteUrl
                Share-SingleFolder -FolderPath $FolderBasePath -FolderName $args[1]
            }
            else {
                Write-ColorOutput "ç”¨æ³•: .\SharePoint_Folder_Share.ps1 share <è³‡æ–™å¤¾åç¨±>" "Yellow"
            }
        }
        "batch" {
            if ($args.Count -ge 2 -and (Test-Path $args[1])) {
                Connect-ToSharePoint -Url $SiteUrl
                $folders = Get-Content $args[1] | Where-Object { $_.Trim() -ne "" }
                Start-BatchShare -FolderNames $folders
            }
            else {
                Write-ColorOutput "ç”¨æ³•: .\SharePoint_Folder_Share.ps1 batch <æª”æ¡ˆè·¯å¾‘>" "Yellow"
            }
        }
        default {
            Write-ColorOutput "å¯ç”¨æŒ‡ä»¤ï¼š" "Yellow"
            Write-ColorOutput "  äº’å‹•æ¨¡å¼: .\SharePoint_Folder_Share.ps1" "Gray"
            Write-ColorOutput "  å–®ä¸€åˆ†äº«: .\SharePoint_Folder_Share.ps1 share <è³‡æ–™å¤¾åç¨±>" "Gray"
            Write-ColorOutput "  æ‰¹æ¬¡åˆ†äº«: .\SharePoint_Folder_Share.ps1 batch <æª”æ¡ˆè·¯å¾‘>" "Gray"
        }
    }
}

# è¨˜éŒ„çµæŸ
Write-ColorOutput "`nåŸ·è¡Œå®Œæˆæ–¼: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" "Gray"